<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ™ºèƒ½åŠŸå¾·ç³»ç»Ÿ</title>

<style>
/* ================= ä¸»é¢˜ä¸æ’ç‰ˆ ================= */
body {
    margin: 0;
    /* æ·±è‰²ç¦…æ„èƒŒæ™¯ */
    background: linear-gradient(180deg, #1c1511 0%, #0a0806 100%);
    color: #fce2a1;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    overflow: hidden; /* é˜²æ­¢ç‚¹å‡»ç‰¹æ•ˆå¯¼è‡´æ»šåŠ¨æ¡é—ªçƒ */
    user-select: none; /* é˜²æ­¢é¢‘ç¹ç‚¹å‡»æ—¶é€‰ä¸­æ–‡æœ¬ */
}

.container {
    width: 95%;
    max-width: 420px;
    margin: 20px 0;
    z-index: 10;
}

.card {
    background: rgba(30, 22, 16, 0.85);
    border: 1px solid #4a3825;
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(230, 175, 75, 0.05);
    text-align: center;
    backdrop-filter: blur(10px);
}

h2 {
    margin: 0 0 20px;
    font-size: 22px;
    text-shadow: 0 2px 10px rgba(252, 226, 161, 0.5);
    letter-spacing: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

/* ================= ä½›å…‰ä¸åª’ä½“å®¹å™¨ ================= */
.media-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 3/4;
    margin: 0 auto 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
}

.buddha-light {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 130%;
    height: 130%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    background: conic-gradient(
        from 0deg, 
        rgba(255, 215, 0, 0.1) 0deg, rgba(255, 165, 0, 0.6) 45deg, 
        rgba(255, 215, 0, 0.1) 90deg, rgba(255, 165, 0, 0.6) 135deg, 
        rgba(255, 215, 0, 0.1) 180deg, rgba(255, 165, 0, 0.6) 225deg, 
        rgba(255, 215, 0, 0.1) 270deg, rgba(255, 165, 0, 0.6) 315deg, 
        rgba(255, 215, 0, 0.1) 360deg
    );
    filter: blur(20px);
    z-index: 0;
    opacity: 0.4;
    animation: spinLight 12s linear infinite;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.buddha-light.flare {
    opacity: 1;
    width: 160%;
    height: 160%;
    filter: blur(15px) brightness(1.8);
    background: conic-gradient(
        from 0deg, 
        rgba(255, 255, 255, 0.6) 0deg, rgba(255, 215, 0, 1) 45deg, 
        rgba(255, 255, 255, 0.6) 90deg, rgba(255, 215, 0, 1) 135deg, 
        rgba(255, 255, 255, 0.6) 180deg, rgba(255, 215, 0, 1) 225deg, 
        rgba(255, 255, 255, 0.6) 270deg, rgba(255, 215, 0, 1) 315deg, 
        rgba(255, 255, 255, 0.6) 360deg
    );
}

@keyframes spinLight {
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

video, img {
    position: relative;
    z-index: 1;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 16px;
    background: #000;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
    border: 2px solid rgba(252, 226, 161, 0.2);
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°wrapperä¸Š */
}

/* ================= æŒ‰é’®ä¸æ§åˆ¶åŒº ================= */
.controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
}

button, .file-upload-label {
    width: 100%;
    padding: 12px 10px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: linear-gradient(135deg, #c29b57, #966f33);
    color: #1a120c;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.4);
    transition: transform 0.1s, filter 0.2s;
}

button:active, .file-upload-label:active {
    transform: scale(0.96);
    filter: brightness(0.9);
}

.file-upload-label {
    background: linear-gradient(135deg, #5c4b3a, #362a20);
    color: #fce2a1;
    border: 1px solid #705840;
}

input[type="file"] {
    display: none;
}

.btn-full {
    grid-column: span 2;
    background: linear-gradient(135deg, #4a3825, #261b11);
    color: #fce2a1;
    border: 1px solid #705840;
}

/* ================= æ•°æ®ä¸ç‚¹å‡»ç‰¹æ•ˆ ================= */
.counter {
    font-size: 28px;
    margin-top: 20px;
    font-weight: bold;
    color: #ffdf70;
    text-shadow: 0 0 15px rgba(255, 223, 112, 0.6);
}

.status {
    font-size: 14px;
    color: #a68c6d;
    margin-top: 8px;
    letter-spacing: 1px;
}

.flash { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes pop {
    50% { transform: scale(1.2); text-shadow: 0 0 30px rgba(255, 255, 255, 0.8); color: #fff; }
}

/* å±å¹•ç‚¹å‡»é£˜å­—ç‰¹æ•ˆ */
.floating-text {
    position: fixed;
    color: #ffdf70;
    font-weight: bold;
    font-size: 18px;
    pointer-events: none;
    z-index: 9999;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    animation: floatUp 1s ease-out forwards;
}

@keyframes floatUp {
    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
    20% { transform: translate(-50%, -80px) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -150px) scale(1); opacity: 0; }
}
</style>
</head>

<body>

<div class="container">
    <div class="card">

        <h2>
            <svg viewBox="0 0 24 24" width="28" height="28" fill="#fce2a1">
                <path d="M12,2C12,2 9,7 9,11C9,15 12,22 12,22C12,22 15,15 15,11C15,7 12,2 12,2M8.14,6.72C7.39,7.84 7,9.3 7,11C7,15.19 10.14,19.26 12,21.5C9.8,20.08 4,15.7 4,11C4,8.5 5.5,6.34 8.14,6.72M15.86,6.72C18.5,6.34 20,8.5 20,11C20,15.7 14.2,20.08 12,21.5C13.86,19.26 17,15.19 17,11C17,9.3 16.61,7.84 15.86,6.72Z"/>
            </svg>
            æ™ºèƒ½åŠŸå¾·ç³»ç»Ÿ
        </h2>

        <div class="media-wrapper">
            <div id="buddhaLight" class="buddha-light"></div>
            <video id="video" autoplay playsinline style="display:none"></video>
            <img id="customImg" style="display:none"/>
        </div>

        <div class="controls">
            <button onclick="startCamera()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm8 13a5 5 0 1 0 0-10 5 5 0 0 0 0 10z"/></svg>
                å¼€å¯æ³•çœ¼
            </button>
            <button onclick="switchCamera()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                åˆ‡æ¢é•œå¤´
            </button>
            
            <label class="file-upload-label">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                ä¾›å¥‰æ³•ç›¸
                <input type="file" accept="image/*" onchange="uploadImage(event)">
            </label>
            <button onclick="useCameraView()" style="background: linear-gradient(135deg, #5c4b3a, #362a20); color: #fce2a1; border: 1px solid #705840;">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                æ¢å¤æ³•çœ¼
            </button>
            
            <button class="btn-full" onclick="enableSensor()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M16,1H8C6.89,1 6,1.89 6,3V21C6,22.11 6.89,23 8,23H16C17.11,23 18,22.11 18,21V3C18,1.89 17.11,1 16,1ZM16,21H8V3H16V21ZM14.9,9.31L12,12.21L9.1,9.31L7.69,10.72L12,15.03L16.31,10.72L14.9,9.31Z"/></svg>
                å¼€å¯æ™ºèƒ½å©æ‹œ (ä¼ æ„Ÿå™¨)
            </button>
        </div>

        <div id="count" class="counter"></div>
        <div id="status" class="status">é™å¾…å–„ç¼˜ (æ•²å‡»å±å¹•äº¦å¯ä¿®è¡Œ)...</div>

    </div>
</div>

<script>
const video = document.getElementById("video");
const img = document.getElementById("customImg");
const countEl = document.getElementById("count");
const statusEl = document.getElementById("status");
const buddhaLight = document.getElementById("buddhaLight");

/* ========= æœ¬åœ°å­˜å‚¨ ========= */
let merit = parseInt(localStorage.getItem("merit") || "0");
countEl.innerText = "åŠŸå¾·ï¼š" + merit;

function saveMerit(){
    localStorage.setItem("merit", merit);
}

/* ========= åŠŸå¾·å¢åŠ ä¸ç‰¹æ•ˆ ========= */
function addMerit(reason, x, y){
    merit++;
    saveMerit();

    // åˆ·æ–°æ•°å­—å’ŒåŠ¨ç”»
    countEl.innerText = "åŠŸå¾·ï¼š" + merit;
    countEl.classList.remove("flash");
    void countEl.offsetWidth; // è§¦å‘é‡ç»˜
    countEl.classList.add("flash");

    // è§¦å‘ä½›å…‰çˆ†å‘
    buddhaLight.classList.remove("flare");
    void buddhaLight.offsetWidth;
    buddhaLight.classList.add("flare");

    statusEl.innerText = "è§¦å‘ï¼š" + reason + " ğŸ™";

    // æ‰‹æœºéœ‡åŠ¨åé¦ˆ (æçŸ­çš„è½»å‡»éœ‡åŠ¨)
    if(navigator.vibrate) navigator.vibrate(30);

    // é£˜å­—ç‰¹æ•ˆ
    if (x !== undefined && y !== undefined) {
        showFloatingText(x, y);
    }

    // è‡ªåŠ¨æ¢å¤ä½›å…‰
    setTimeout(() => {
        buddhaLight.classList.remove("flare");
    }, 400); // ç¼©çŸ­ä½›å…‰é«˜äº®æ—¶é—´ï¼Œé€‚åˆè¿ç»­ç‚¹å‡»
}

/* å±å¹•ç‚¹å‡»æ¼‚æµ®ç‰¹æ•ˆ */
function showFloatingText(x, y) {
    const span = document.createElement('span');
    span.innerText = "åŠŸå¾· +1";
    span.className = 'floating-text';
    span.style.left = x + 'px';
    span.style.top = y + 'px';
    document.body.appendChild(span);
    
    setTimeout(() => {
        span.remove();
    }, 1000);
}

/* ========= ç›‘å¬å…¨å±æ•²å‡» ========= */
document.body.addEventListener('pointerdown', function(e) {
    // é˜²æ­¢ç‚¹å‡»åˆ°æŒ‰é’®ã€è¾“å…¥æ¡†ç­‰ UI å…ƒç´ æ—¶ä¹Ÿè§¦å‘
    const ignoredTags = ['BUTTON', 'INPUT', 'LABEL', 'SVG', 'PATH'];
    if (ignoredTags.includes(e.target.tagName.toUpperCase())) return;
    if (e.target.closest('button') || e.target.closest('label')) return;

    // è§¦å‘ç‚¹å‡»åŠŸå¾·
    addMerit("è™”è¯šæ•²å‡»", e.clientX, e.clientY);
});

/* ========= æ‘„åƒå¤´ ========= */
let useFront = false;
let currentStream = null;

async function startCamera(){
    try{
        if(currentStream){
            currentStream.getTracks().forEach(t => t.stop());
        }

        const stream = await navigator.mediaDevices.getUserMedia({
            video: {facingMode: "environment"},
            audio: false
        });

        currentStream = stream;
        video.srcObject = stream;

        video.style.display = "block";
        img.style.display = "none";

        statusEl.innerText = "åç½®æ³•çœ¼å·²å¼€å¯";
    }catch(e){
        alert("æ³•çœ¼å¼€å¯å¤±è´¥ï¼š" + e.message);
    }
}

async function switchCamera(){
    if(!currentStream) return alert("è¯·å…ˆå¼€å¯ç›¸æœº");
    useFront = !useFront;

    const stream = await navigator.mediaDevices.getUserMedia({
        video: {facingMode: useFront ? "user" : "environment"}
    });

    currentStream.getTracks().forEach(t => t.stop());
    currentStream = stream;
    video.srcObject = stream;

    statusEl.innerText = useFront ? "å‰ç½®æ³•çœ¼" : "åç½®æ³•çœ¼";
}

/* ========= ä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡ ========= */
function uploadImage(e){
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(ev){
        img.src = ev.target.result;
        localStorage.setItem("customImage", ev.target.result);

        img.style.display = "block";
        video.style.display = "none";

        statusEl.innerText = "å·²ä¾›å¥‰è‡ªå®šä¹‰æ³•ç›¸";
    };
    reader.readAsDataURL(file);
}

/* æ¢å¤ç¼“å­˜å›¾ç‰‡ */
const savedImg = localStorage.getItem("customImage");
if(savedImg){
    img.src = savedImg;
    img.style.display = "block";
    video.style.display = "none";
} else {
    // é»˜è®¤å±•ç¤º
    img.style.display = "block";
}

/* åˆ‡å›ç›¸æœº */
function useCameraView(){
    if(currentStream) {
        img.style.display = "none";
        video.style.display = "block";
        statusEl.innerText = "å·²æ¢å¤æ³•çœ¼ç”»é¢";
    } else {
        startCamera();
    }
}

/* ========= æ‰‹æœºä¼ æ„Ÿå™¨è¯†åˆ« ========= */
let lastTrigger = 0;

async function enableSensor(){
    // iOSæƒé™ç”³è¯·
    if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === "function"){
        try{
            const res = await DeviceOrientationEvent.requestPermission();
            if(res !== "granted"){
                alert("æœªå…è®¸ä¼ æ„Ÿå™¨æƒé™ï¼Œæ— æ³•æ„ŸçŸ¥å©æ‹œ");
                return;
            }
        }catch(e){alert(e);}
    }

    window.addEventListener("deviceorientation", handleOrientation);
    statusEl.innerText = "å…­æ ¹æ¸…å‡€ï¼Œæ™ºèƒ½å©æ‹œå·²å¼€å¯";
}

function handleOrientation(event){
    const beta = event.beta; // å‰åå€¾è§’
    // å‰å€¾è¶…è¿‡40åº¦è§¦å‘
    if(beta > 40){
        const now = Date.now();
        if(now - lastTrigger > 1500){ // å©æ‹œå†·å´æ—¶é—´è®¾ä¸º1.5ç§’
            lastTrigger = now;
            // è·å–é¡µé¢ä¸­å¿ƒä½ç½®è§¦å‘é£˜å­—
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2 - 50;
            addMerit("è™”è¯šå©æ‹œ", centerX, centerY);
        }
    }
}
</script>

</body>
</html>
