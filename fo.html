<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>æ™ºèƒ½ç”µå­åŠŸå¾·ç®±</title>

<style>
body{
    margin:0;
    background:linear-gradient(180deg,#eef3ff,#ffffff);
    font-family:-apple-system,BlinkMacSystemFont;
    display:flex;
    justify-content:center;
}

.container{
    width:95%;
    max-width:420px;
    margin-top:20px;
}

.card{
    background:#fff;
    border-radius:20px;
    padding:18px;
    box-shadow:0 10px 25px rgba(0,0,0,.08);
    text-align:center;
}

h2{
    margin:5px 0 10px;
}

video{
    width:100%;
    border-radius:14px;
    background:#000;
}

button{
    width:100%;
    margin-top:12px;
    padding:14px;
    border:none;
    border-radius:14px;
    background:#4a7cff;
    color:#fff;
    font-size:16px;
}

.counter{
    font-size:20px;
    margin-top:12px;
}

.status{
    font-size:13px;
    color:#666;
    margin-top:6px;
}

.flash{
    animation:pop .35s;
}

@keyframes pop{
    50%{transform:scale(1.25)}
}
</style>
</head>

<body>

<div class="container">
<div class="card">

<h2>ğŸ“¿ æ™ºèƒ½åŠŸå¾·ç³»ç»Ÿ</h2>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none"></canvas>

<button onclick="startCamera()">å¼€å¯ç›¸æœº</button>

<div id="count" class="counter"></div>
<div id="status" class="status">ç­‰å¾…å¯åŠ¨</div>

</div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const countEl = document.getElementById("count");
const statusEl = document.getElementById("status");

/* ========= æœ¬åœ°å­˜å‚¨ ========= */
let merit = parseInt(localStorage.getItem("merit")||"0");
countEl.innerText="åŠŸå¾·ï¼š"+merit;

function save(){
    localStorage.setItem("merit",merit);
}

/* ========= ç›¸æœº ========= */
async function startCamera(){
    try{
        const stream = await navigator.mediaDevices.getUserMedia({
            video:{facingMode:"user"},
            audio:false
        });

        video.srcObject = stream;
        statusEl.innerText="è‡ªåŠ¨è¯†åˆ«ä¸­...";
        startDetection();

    }catch(e){
        alert("æ— æ³•æ‰“å¼€ç›¸æœºï¼š"+e.message);
    }
}

/* ========= è‡ªåŠ¨è¯†åˆ« ========= */

let lastFrame=null;
let detecting=false;
let cooldown=false;

function startDetection(){
    detecting=true;

    setInterval(()=>{
        if(!detecting || video.readyState!==4) return;

        canvas.width=video.videoWidth/4;
        canvas.height=video.videoHeight/4;

        ctx.drawImage(video,0,0,canvas.width,canvas.height);

        const frame=ctx.getImageData(0,0,canvas.width,canvas.height).data;

        if(lastFrame){
            let diff=0;

            for(let i=0;i<frame.length;i+=20){
                diff+=Math.abs(frame[i]-lastFrame[i]);
            }

            // è¿åŠ¨é˜ˆå€¼ï¼ˆæ‹œåŠ¨ä½œï¼‰
            if(diff>90000 && !cooldown){
                addMerit();
                cooldown=true;
                setTimeout(()=>cooldown=false,1500);
            }
        }

        lastFrame=new Uint8ClampedArray(frame);

    },250);
}

/* ========= åŠŸå¾·å¢åŠ  ========= */

function addMerit(){
    merit++;
    save();

    countEl.innerText="åŠŸå¾·ï¼š"+merit;

    countEl.classList.remove("flash");
    void countEl.offsetWidth;
    countEl.classList.add("flash");

    statusEl.innerText="æ£€æµ‹åˆ°æ‹œä¸€æ‹œ ğŸ™";

    if(navigator.vibrate){
        navigator.vibrate(60);
    }
}
</script>

</body>
</html>