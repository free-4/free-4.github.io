<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>æ™ºèƒ½åŠŸå¾·ç³»ç»Ÿ</title>

<style>
/* ================= ä¸»é¢˜ä¸æ’ç‰ˆ ================= */
body {
    margin: 0;
    background: linear-gradient(180deg, #1c1511 0%, #0a0806 100%);
    color: #fce2a1;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    display: flex;
    justify-content: center;
    /* é€‚é…ç°ä»£æ‰‹æœºæµè§ˆå™¨ï¼Œé˜²æ­¢åº•éƒ¨åœ°å€æ é®æŒ¡ */
    min-height: 100vh;
    min-height: 100dvh; 
    overflow: hidden; 
    user-select: none; 
    -webkit-user-select: none; /* iOS Safari å…¼å®¹ */
    touch-action: manipulation; /* å½»åº•ç¦ç”¨åŒå‡»æ”¾å¤§ï¼Œæå‡è¿å‡»å“åº”é€Ÿåº¦ */
}

.container {
    width: 95%;
    max-width: 420px;
    margin: 20px 0;
    z-index: 10;
}

.card {
    background: rgba(30, 22, 16, 0.85);
    border: 1px solid #4a3825;
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
    /* ç§»åŠ¨ç«¯æ…ç”¨é«˜å¼ºåº¦ backdrop-filterï¼Œè‹¥ä¾ç„¶å¡é¡¿å¯åˆ é™¤æ­¤è¡Œ */
    backdrop-filter: blur(8px); 
    -webkit-backdrop-filter: blur(8px);
    text-align: center;
}

h2 {
    margin: 0 0 20px;
    font-size: 22px;
    text-shadow: 0 2px 10px rgba(252, 226, 161, 0.5);
    letter-spacing: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

/* ================= ä½›å…‰ä¸åª’ä½“å®¹å™¨ ================= */
.media-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 3/4;
    margin: 0 auto 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
}

.buddha-light {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 130%;
    height: 130%;
    /* å¼€å¯ GPU ç¡¬ä»¶åŠ é€Ÿï¼Œå¤§å¹…é™ä½ç§»åŠ¨ç«¯å¡é¡¿ */
    transform: translate3d(-50%, -50%, 0); 
    will-change: transform, opacity, filter;
    border-radius: 50%;
    background: conic-gradient(
        from 0deg, 
        rgba(255, 215, 0, 0.1) 0deg, rgba(255, 165, 0, 0.6) 45deg, 
        rgba(255, 215, 0, 0.1) 90deg, rgba(255, 165, 0, 0.6) 135deg, 
        rgba(255, 215, 0, 0.1) 180deg, rgba(255, 165, 0, 0.6) 225deg, 
        rgba(255, 215, 0, 0.1) 270deg, rgba(255, 165, 0, 0.6) 315deg, 
        rgba(255, 215, 0, 0.1) 360deg
    );
    filter: blur(15px); /* ç•¥å¾®è°ƒä½blurå€¼ï¼Œä¼˜åŒ–æ€§èƒ½ */
    z-index: 0;
    opacity: 0.4;
    animation: spinLight 12s linear infinite;
    transition: opacity 0.3s ease-out, filter 0.3s ease-out;
}

.buddha-light.flare {
    opacity: 1;
    filter: blur(10px) brightness(1.5);
}

@keyframes spinLight {
    100% { transform: translate3d(-50%, -50%, 0) rotate(360deg); }
}

video, img {
    position: relative;
    z-index: 1;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 16px;
    background: #000;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
    border: 2px solid rgba(252, 226, 161, 0.2);
    pointer-events: none; 
}

/* ================= æŒ‰é’®ä¸æ§åˆ¶åŒº ================= */
.controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
}

button, .file-upload-label {
    width: 100%;
    padding: 12px 10px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: linear-gradient(135deg, #c29b57, #966f33);
    color: #1a120c;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.4);
    transition: transform 0.1s, filter 0.2s;
    /* é˜²æ­¢iOSç‚¹å‡»é«˜äº® */
    -webkit-tap-highlight-color: transparent; 
}

button:active, .file-upload-label:active {
    transform: scale(0.96);
    filter: brightness(0.9);
}

.file-upload-label {
    background: linear-gradient(135deg, #5c4b3a, #362a20);
    color: #fce2a1;
    border: 1px solid #705840;
}

input[type="file"] {
    display: none;
}

.btn-full {
    grid-column: span 2;
    background: linear-gradient(135deg, #4a3825, #261b11);
    color: #fce2a1;
    border: 1px solid #705840;
}

/* ================= æ•°æ®ä¸ç‚¹å‡»ç‰¹æ•ˆ ================= */
.counter {
    font-size: 28px;
    margin-top: 20px;
    font-weight: bold;
    color: #ffdf70;
    text-shadow: 0 0 15px rgba(255, 223, 112, 0.6);
    will-change: transform;
}

.status {
    font-size: 14px;
    color: #a68c6d;
    margin-top: 8px;
    letter-spacing: 1px;
}

.flash { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes pop {
    50% { transform: scale(1.15); text-shadow: 0 0 20px rgba(255, 255, 255, 0.8); color: #fff; }
}

/* å±å¹•ç‚¹å‡»é£˜å­—ç‰¹æ•ˆ */
.floating-text {
    position: fixed;
    color: #ffdf70;
    font-weight: bold;
    font-size: 18px;
    pointer-events: none;
    z-index: 9999;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    will-change: transform, opacity; /* ç¡¬ä»¶åŠ é€Ÿ */
    animation: floatUp 0.8s ease-out forwards;
}

@keyframes floatUp {
    0% { transform: translate3d(-50%, -50%, 0) scale(0.8); opacity: 1; }
    20% { transform: translate3d(-50%, -80px, 0) scale(1.2); opacity: 1; }
    100% { transform: translate3d(-50%, -150px, 0) scale(1); opacity: 0; }
}
</style>
</head>

<body>

<div class="container">
    <div class="card">
        <h2>
            <svg viewBox="0 0 24 24" width="28" height="28" fill="#fce2a1">
                <path d="M12,2C12,2 9,7 9,11C9,15 12,22 12,22C12,22 15,15 15,11C15,7 12,2 12,2M8.14,6.72C7.39,7.84 7,9.3 7,11C7,15.19 10.14,19.26 12,21.5C9.8,20.08 4,15.7 4,11C4,8.5 5.5,6.34 8.14,6.72M15.86,6.72C18.5,6.34 20,8.5 20,11C20,15.7 14.2,20.08 12,21.5C13.86,19.26 17,15.19 17,11C17,9.3 16.61,7.84 15.86,6.72Z"/>
            </svg>
            æ™ºèƒ½åŠŸå¾·ç³»ç»Ÿ
        </h2>

        <div class="media-wrapper">
            <div id="buddhaLight" class="buddha-light"></div>
            <video id="video" autoplay playsinline style="display:none"></video>
            <img id="customImg" style="display:none"/>
        </div>

        <div class="controls">
            <button onclick="startCamera()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm8 13a5 5 0 1 0 0-10 5 5 0 0 0 0 10z"/></svg>
                å¼€å¯æ³•çœ¼
            </button>
            <button onclick="switchCamera()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                åˆ‡æ¢é•œå¤´
            </button>
            
            <label class="file-upload-label">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                ä¾›å¥‰æ³•ç›¸
                <input type="file" accept="image/*" onchange="uploadAndCompressImage(event)">
            </label>
            <button onclick="useCameraView()" style="background: linear-gradient(135deg, #5c4b3a, #362a20); color: #fce2a1; border: 1px solid #705840;">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                æ¢å¤æ³•çœ¼
            </button>
            
            <button class="btn-full" onclick="enableSensor()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M16,1H8C6.89,1 6,1.89 6,3V21C6,22.11 6.89,23 8,23H16C17.11,23 18,22.11 18,21V3C18,1.89 17.11,1 16,1ZM16,21H8V3H16V21ZM14.9,9.31L12,12.21L9.1,9.31L7.69,10.72L12,15.03L16.31,10.72L14.9,9.31Z"/></svg>
                å¼€å¯æ™ºèƒ½å©æ‹œ (ä¼ æ„Ÿå™¨)
            </button>
        </div>

        <div id="count" class="counter"></div>
        <div id="status" class="status">é™å¾…å–„ç¼˜ (æ•²å‡»å±å¹•äº¦å¯ä¿®è¡Œ)...</div>

    </div>
</div>

<script>
const video = document.getElementById("video");
const img = document.getElementById("customImg");
const countEl = document.getElementById("count");
const statusEl = document.getElementById("status");
const buddhaLight = document.getElementById("buddhaLight");

let lightTimeout;

/* ========= æœ¬åœ°å­˜å‚¨ ========= */
let merit = parseInt(localStorage.getItem("merit") || "0");
countEl.innerText = "åŠŸå¾·ï¼š" + merit;

function saveMerit(){
    localStorage.setItem("merit", merit);
}

/* ========= åŠŸå¾·å¢åŠ ä¸ç‰¹æ•ˆ ========= */
function addMerit(reason, x, y){
    merit++;
    saveMerit();

    countEl.innerText = "åŠŸå¾·ï¼š" + merit;
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ classList.toggle æˆ–ç›´æ¥é‡ç½®åŠ¨ç”»ï¼Œé¿å…æ»¥ç”¨ offsetWidth å¼•å‘å¼ºåˆ¶åŒæ­¥å¸ƒå±€
    countEl.classList.remove("flash");
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            countEl.classList.add("flash");
        });
    });

    // è§¦å‘ä½›å…‰çˆ†å‘
    buddhaLight.classList.add("flare");
    clearTimeout(lightTimeout);
    lightTimeout = setTimeout(() => {
        buddhaLight.classList.remove("flare");
    }, 300); // ç¼©çŸ­é«˜äº®æ—¶é—´ï¼Œæå‡è¿ç»­ç‚¹å‡»çš„æµç•…æ„Ÿ

    statusEl.innerText = "è§¦å‘ï¼š" + reason + " ğŸ™";

    // æ‰‹æœºéœ‡åŠ¨åé¦ˆ
    if(navigator.vibrate) {
        try { navigator.vibrate(20); } catch(e){} 
    }

    // é£˜å­—ç‰¹æ•ˆ
    if (x !== undefined && y !== undefined) {
        showFloatingText(x, y);
    }
}

/* å±å¹•ç‚¹å‡»æ¼‚æµ®ç‰¹æ•ˆä¼˜åŒ– */
function showFloatingText(x, y) {
    const span = document.createElement('span');
    span.innerText = "åŠŸå¾· +1";
    span.className = 'floating-text';
    span.style.left = x + 'px';
    span.style.top = y + 'px';
    document.body.appendChild(span);
    
    // ç›‘å¬åŠ¨ç”»ç»“æŸè‡ªåŠ¨æ¸…ç† DOMï¼Œæ¯” setTimeout æ›´å‡†ç¡®ä¸”èŠ‚çœå†…å­˜
    span.addEventListener('animationend', () => {
        span.remove();
    });
}

/* ========= ç›‘å¬å…¨å±æ•²å‡» ========= */
// ä½¿ç”¨ pointerdown å…¼å®¹æ€§å¥½ï¼Œå“åº”é€Ÿåº¦å¿«
document.body.addEventListener('pointerdown', function(e) {
    const ignoredTags = ['BUTTON', 'INPUT', 'LABEL', 'SVG', 'PATH'];
    if (ignoredTags.includes(e.target.tagName.toUpperCase())) return;
    if (e.target.closest('button') || e.target.closest('label')) return;

    addMerit("è™”è¯šæ•²å‡»", e.clientX, e.clientY);
});

/* ========= æ‘„åƒå¤´ ========= */
let useFront = false;
let currentStream = null;

async function startCamera(){
    try{
        if(currentStream){
            currentStream.getTracks().forEach(t => t.stop());
        }

        const stream = await navigator.mediaDevices.getUserMedia({
            video: {facingMode: "environment"},
            audio: false
        });

        currentStream = stream;
        video.srcObject = stream;
        video.style.display = "block";
        img.style.display = "none";
        statusEl.innerText = "åç½®æ³•çœ¼å·²å¼€å¯";
    }catch(e){
        alert("æ³•çœ¼å¼€å¯å¤±è´¥ï¼š" + e.message);
    }
}

async function switchCamera(){
    if(!currentStream) return alert("è¯·å…ˆå¼€å¯æ³•çœ¼");
    useFront = !useFront;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {facingMode: useFront ? "user" : "environment"}
        });

        currentStream.getTracks().forEach(t => t.stop());
        currentStream = stream;
        video.srcObject = stream;
        statusEl.innerText = useFront ? "å‰ç½®æ³•çœ¼" : "åç½®æ³•çœ¼";
    } catch(e) {
        alert("åˆ‡æ¢å¤±è´¥");
    }
}

/* ========= ä¸Šä¼ å¹¶å‹ç¼©è‡ªå®šä¹‰å›¾ç‰‡ (æ ¸å¿ƒä¿®å¤ç‚¹) ========= */
function uploadAndCompressImage(e){
    const file = e.target.files[0];
    if(!file) return;
    
    statusEl.innerText = "æ³•ç›¸è¯·ç¥ä¸­...";

    const reader = new FileReader();
    reader.onload = function(ev){
        const image = new Image();
        image.onload = function() {
            // ä½¿ç”¨ Canvas å¯¹å¤§å›¾è¿›è¡Œå‹ç¼©ï¼Œé˜²æ­¢æ’‘çˆ† localStorage
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // é™åˆ¶æœ€å¤§å®½é«˜ï¼Œè¶³å¤Ÿåœ¨æ‰‹æœºç«¯æ¸…æ™°æ˜¾ç¤ºå³å¯
            const MAX_WIDTH = 800;
            const MAX_HEIGHT = 800;
            let width = image.width;
            let height = image.height;

            if (width > height) {
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
            } else {
                if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(image, 0, 0, width, height);
            
            // å¯¼å‡ºä¸º JPEG æ ¼å¼ï¼Œè´¨é‡è®¾ä¸º 0.7ï¼Œå¤§å¹…å‡å°ä½“ç§¯
            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
            
            try {
                localStorage.setItem("customImage", compressedDataUrl);
                img.src = compressedDataUrl;
                img.style.display = "block";
                video.style.display = "none";
                statusEl.innerText = "å·²ä¾›å¥‰è‡ªå®šä¹‰æ³•ç›¸";
            } catch (err) {
                alert("æ³•ç›¸è¿‡å¤§ï¼ŒåŠŸå¾·ç®±(ç¼“å­˜)å·²æ»¡ï¼Œè¯·æ¸…ç†æµè§ˆå™¨ç¼“å­˜æˆ–ä½¿ç”¨æ›´å°çš„å›¾ç‰‡ï¼");
                statusEl.innerText = "ä¾›å¥‰å¤±è´¥";
            }
        };
        image.src = ev.target.result;
    };
    reader.readAsDataURL(file);
    
    // é‡ç½® inputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€å¼ å›¾ç‰‡
    e.target.value = '';
}

/* æ¢å¤ç¼“å­˜å›¾ç‰‡ */
try {
    const savedImg = localStorage.getItem("customImage");
    if(savedImg){
        img.src = savedImg;
        img.style.display = "block";
        video.style.display = "none";
    } else {
        img.style.display = "block";
    }
} catch(e) {
    // å¿½ç•¥è·¨åŸŸæˆ–éšç§æ¨¡å¼ä¸‹çš„é”™è¯¯
}

/* åˆ‡å›ç›¸æœº */
function useCameraView(){
    if(currentStream) {
        img.style.display = "none";
        video.style.display = "block";
        statusEl.innerText = "å·²æ¢å¤æ³•çœ¼ç”»é¢";
    } else {
        startCamera();
    }
}

/* ========= æ‰‹æœºä¼ æ„Ÿå™¨è¯†åˆ« (ä¿®æ­£ç‰ˆ) ========= */
let lastTrigger = 0;
let bowState = 0; // è®°å½•å©æ‹œçŠ¶æ€ï¼š0ä¸ºæ­£å¸¸ç›´ç«‹ï¼Œ1ä¸ºä¿¯èº«å©æ‹œä¸­

async function enableSensor(){
    // iOS 13+ æƒé™ç”³è¯·
    if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === "function"){
        try {
            const res = await DeviceOrientationEvent.requestPermission();
            if(res !== "granted"){
                alert("æœªå…è®¸ä¼ æ„Ÿå™¨æƒé™ï¼Œæ— æ³•æ„ŸçŸ¥å©æ‹œ");
                return;
            }
        } catch(e) {
            alert("è¯·åœ¨ HTTPS ç¯å¢ƒä¸‹è¿è¡Œï¼Œæˆ–åœ¨æ‰‹æœºè®¾ç½®ä¸­å¼€å¯ç½‘é¡µä¼ æ„Ÿå™¨æƒé™ï¼");
            return;
        }
    }

    // ç›‘å¬è®¾å¤‡æ–¹å‘å˜åŒ–
    window.addEventListener("deviceorientation", handleOrientation);
    statusEl.innerText = "å…­æ ¹æ¸…å‡€ï¼Œæ™ºèƒ½å©æ‹œå·²å¼€å¯ (è¯·å°†æ‰‹æœºè´´è¿‘èƒ¸å£ï¼Œå¼¯è…°é èº¬)";
}

function handleOrientation(event){
    // beta èŒƒå›´æ˜¯ -180 åˆ° 180ï¼Œä»£è¡¨è®¾å¤‡å‰åçš„å€¾æ–œè§’åº¦
    let beta = event.beta; 
    
    // å¦‚æœ beta æ˜¯ nullï¼Œè¯´æ˜è®¾å¤‡æ²¡æœ‰é™€èºä»ªæˆ–è¢«æµè§ˆå™¨å½»åº•æ‹¦æˆª
    if (beta === null) return;

    // ã€åŠ¨ä½œ 1ï¼šä¿¯èº«ã€‘æ‰‹æœºåŸæœ¬æ˜¯ç›´ç«‹çš„ï¼Œç°åœ¨å‰å€¾ï¼ˆå¼¯è…°ï¼‰è‡³è¶‹äºå¹³æ”¾çŠ¶æ€
    if (beta < 40 && beta > -20 && bowState === 0) {
        bowState = 1; // è®°å½•ï¼šå·²å¼¯è…°
        statusEl.innerText = "å¼¯è…°ä¸­... (è¯·èµ·èº«)";
    }
    
    // ã€åŠ¨ä½œ 2ï¼šèµ·èº«ã€‘ä»å¼¯è…°çŠ¶æ€æ¢å¤åˆ°äº†ç›´ç«‹çŠ¶æ€ï¼ˆå®Œæˆä¸€æ¬¡å®Œæ•´å©æ‹œï¼‰
    if (beta > 65 && bowState === 1) {
        bowState = 0; // é‡ç½®çŠ¶æ€
        const now = Date.now();
        
        // é˜²æŠ–å†·å´æ—¶é—´è®¾ä¸º1.2ç§’ï¼Œé˜²æ­¢è¿ç»­ä¹±è§¦å‘
        if(now - lastTrigger > 1200){ 
            lastTrigger = now;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2 - 50;
            addMerit("è™”è¯šå©æ‹œ", centerX, centerY);
        }
    }
}
</script>

</body>
</html>
