<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‰©ç†å®éªŒå®¤ Â· Physics Lab</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;700&display=swap');

  :root {
    --bg: #060d1a;
    --panel: #0a1628;
    --border: #1a3a6b;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --accent3: #a8ff3e;
    --text: #c8deff;
    --muted: #4a6fa5;
    --glow: 0 0 20px rgba(0,229,255,0.4);
    --glow2: 0 0 20px rgba(255,107,53,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans SC', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative;
    z-index: 10;
    padding: 20px 40px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 20px;
    background: rgba(6,13,26,0.9);
    backdrop-filter: blur(10px);
  }

  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 1.4rem;
    color: var(--accent);
    text-shadow: var(--glow);
    letter-spacing: 2px;
  }

  .logo span { color: var(--text); }

  .subtitle {
    font-size: 0.75rem;
    color: var(--muted);
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  /* Tab navigation */
  .tabs {
    position: relative;
    z-index: 10;
    display: flex;
    gap: 0;
    padding: 0 40px;
    background: rgba(10,22,40,0.95);
    border-bottom: 1px solid var(--border);
  }

  .tab {
    padding: 16px 28px;
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    letter-spacing: 0.5px;
    user-select: none;
  }

  .tab:hover { color: var(--text); }

  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
    text-shadow: var(--glow);
  }

  .tab-icon { font-size: 1.1rem; }

  /* Main layout */
  .main {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 0;
    height: calc(100vh - 110px);
  }

  .canvas-area {
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  canvas {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: #020810;
    cursor: crosshair;
    display: block;
  }

  /* Sidebar */
  .sidebar {
    border-left: 1px solid var(--border);
    background: rgba(10,22,40,0.8);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }

  .sidebar-section {
    padding: 20px;
    border-bottom: 1px solid rgba(26,58,107,0.5);
  }

  .sidebar-section h3 {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 2px;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 16px;
  }

  /* Sliders */
  .param {
    margin-bottom: 16px;
  }

  .param-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    margin-bottom: 6px;
    color: var(--text);
  }

  .param-value {
    font-family: 'Space Mono', monospace;
    color: var(--accent2);
    font-size: 0.85rem;
  }

  input[type=range] {
    width: 100%;
    -webkit-appearance: none;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
  }

  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 0 8px rgba(0,229,255,0.6);
  }

  /* Buttons */
  .btn {
    padding: 10px 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer;
    border-radius: 4px;
    letter-spacing: 1px;
    transition: all 0.2s;
  }

  .btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: var(--glow);
  }

  .btn-primary {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
    font-weight: 700;
  }

  .btn-primary:hover {
    background: transparent;
    color: var(--accent);
  }

  .btn-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Info card */
  .info-card {
    background: rgba(0,229,255,0.05);
    border: 1px solid rgba(0,229,255,0.15);
    border-radius: 6px;
    padding: 14px;
    font-size: 0.78rem;
    line-height: 1.7;
    color: var(--text);
  }

  .info-card .formula {
    font-family: 'Space Mono', monospace;
    color: var(--accent3);
    font-size: 0.85rem;
    margin: 8px 0;
    padding: 6px 10px;
    background: rgba(168,255,62,0.08);
    border-radius: 4px;
    border-left: 2px solid var(--accent3);
  }

  /* Score / stats */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .stat-box {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    text-align: center;
  }

  .stat-num {
    font-family: 'Space Mono', monospace;
    font-size: 1.4rem;
    color: var(--accent);
    text-shadow: var(--glow);
  }

  .stat-label {
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 2px;
  }

  /* Message overlay */
  .message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Space Mono', monospace;
    font-size: 1.5rem;
    color: var(--accent3);
    text-shadow: 0 0 20px rgba(168,255,62,0.8);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s;
    white-space: nowrap;
    z-index: 99;
  }

  .message.show {
    opacity: 1;
    animation: fadeMsg 2s forwards;
  }

  @keyframes fadeMsg {
    0% { opacity: 1; transform: translate(-50%, -50%); }
    70% { opacity: 1; transform: translate(-50%, -60%); }
    100% { opacity: 0; transform: translate(-50%, -70%); }
  }

  .page { display: none; }
  .page.active { display: contents; }

  /* Collision mode buttons */
  .mode-btn {
    padding: 7px 14px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.2s;
  }
  .mode-btn.active, .mode-btn:hover {
    border-color: var(--accent2);
    color: var(--accent2);
  }

  /* Pendulum hint */
  .hint {
    font-size: 0.72rem;
    color: var(--muted);
    font-style: italic;
    margin-top: 6px;
  }

  .score-flash {
    animation: scoreFlash 0.5s ease;
  }
  @keyframes scoreFlash {
    0%,100% { color: var(--accent); }
    50% { color: var(--accent3); text-shadow: 0 0 30px rgba(168,255,62,1); }
  }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">PHYSICS<span>LAB</span></div>
    <div class="subtitle">äº’åŠ¨ç‰©ç†å®éªŒå®¤ Â· Interactive</div>
  </div>
</header>

<div class="tabs">
  <div class="tab active" onclick="switchTab('projectile')">
    <span class="tab-icon">ğŸ¯</span> æŠ›ä½“è¿åŠ¨
  </div>
  <div class="tab" onclick="switchTab('pendulum')">
    <span class="tab-icon">ğŸ”„</span> å•æ‘†å®éªŒ
  </div>
  <div class="tab" onclick="switchTab('collision')">
    <span class="tab-icon">ğŸ’¥</span> ç¢°æ’å®ˆæ’
  </div>
</div>

<div class="main">

  <!-- ========== PROJECTILE PAGE ========== -->
  <div class="canvas-area page active" id="page-projectile-canvas">
    <div style="position:relative">
      <canvas id="projectile-canvas" height="440"></canvas>
      <div class="message" id="proj-msg"></div>
    </div>
    <div class="hint" style="color:var(--muted);font-size:0.75rem;padding:0 4px">
      ğŸ’¡ ç‚¹å‡»ç”»é¢ä»»æ„ä½ç½®æˆ–æŒ‰ <strong style="color:var(--accent)">å‘å°„</strong> æŒ‰é’®å‘å°„ç‚®å¼¹ï¼Œå°è¯•å‡»ä¸­æ‰€æœ‰ç›®æ ‡ï¼
    </div>
  </div>

  <div class="sidebar page active" id="page-projectile-side">
    <div class="sidebar-section">
      <h3>âš™ å‘å°„å‚æ•°</h3>
      <div class="param">
        <div class="param-label"><span>å‘å°„è§’åº¦ Î¸</span><span class="param-value" id="angle-val">45Â°</span></div>
        <input type="range" id="angle-slider" min="10" max="80" value="45">
      </div>
      <div class="param">
        <div class="param-label"><span>åˆé€Ÿåº¦ vâ‚€</span><span class="param-value" id="speed-val">50 m/s</span></div>
        <input type="range" id="speed-slider" min="20" max="100" value="50">
      </div>
      <div class="param">
        <div class="param-label"><span>é‡åŠ›åŠ é€Ÿåº¦ g</span><span class="param-value" id="gravity-val">9.8 m/sÂ²</span></div>
        <input type="range" id="gravity-slider" min="1" max="25" value="10" step="0.1">
      </div>
      <div class="btn-row" style="margin-top:12px">
        <button class="btn btn-primary" onclick="fireProjectile()">ğŸš€ å‘å°„</button>
        <button class="btn" onclick="resetProjectile()">é‡ç½®</button>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>ğŸ“Š å®æ—¶æ•°æ®</h3>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-num" id="range-val">â€”</div>
          <div class="stat-label">å°„ç¨‹ (m)</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="maxh-val">â€”</div>
          <div class="stat-label">æœ€é«˜ç‚¹ (m)</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="flight-val">â€”</div>
          <div class="stat-label">é£è¡Œæ—¶é—´ (s)</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="score-val" style="color:var(--accent3)">0</div>
          <div class="stat-label">å‘½ä¸­å¾—åˆ†</div>
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>ğŸ“š ç‰©ç†åŸç†</h3>
      <div class="info-card">
        <strong>æŠ›ä½“è¿åŠ¨</strong>ç”±ä¸¤ä¸ªç‹¬ç«‹è¿åŠ¨åˆæˆï¼š<br>
        æ°´å¹³æ–¹å‘åŒ€é€Ÿè¿åŠ¨ï¼Œç«–ç›´æ–¹å‘åŒ€åŠ é€Ÿè¿åŠ¨ã€‚
        <div class="formula">x = vâ‚€cosÎ¸ Â· t</div>
        <div class="formula">y = vâ‚€sinÎ¸ Â· t âˆ’ Â½gtÂ²</div>
        å½“ Î¸ = 45Â° æ—¶ï¼Œæ°´å¹³å°„ç¨‹æœ€å¤§ï¼<br>
        <span style="color:var(--muted);font-size:0.72rem">è¯•ç€å¯¹æ¯”ä¸åŒè§’åº¦çš„è½¨è¿¹ï½</span>
      </div>
    </div>
  </div>

  <!-- ========== PENDULUM PAGE ========== -->
  <div class="canvas-area page" id="page-pendulum-canvas">
    <canvas id="pendulum-canvas" height="440"></canvas>
    <div class="hint">ğŸ’¡ æ‹–åŠ¨æ‘†çƒæ”¹å˜åˆå§‹è§’åº¦ï¼Œè§‚å¯Ÿæ‘†é•¿å¯¹å‘¨æœŸçš„å½±å“</div>
  </div>

  <div class="sidebar page" id="page-pendulum-side">
    <div class="sidebar-section">
      <h3>âš™ å®éªŒå‚æ•°</h3>
      <div class="param">
        <div class="param-label"><span>æ‘†é•¿ L</span><span class="param-value" id="plen-val">1.0 m</span></div>
        <input type="range" id="plen-slider" min="0.2" max="3.0" value="1.0" step="0.05">
      </div>
      <div class="param">
        <div class="param-label"><span>é‡åŠ›åŠ é€Ÿåº¦ g</span><span class="param-value" id="pgrav-val">9.8 m/sÂ²</span></div>
        <input type="range" id="pgrav-slider" min="1" max="25" value="9.8" step="0.1">
      </div>
      <div class="param">
        <div class="param-label"><span>é˜»å°¼ç³»æ•°</span><span class="param-value" id="damp-val">0.999</span></div>
        <input type="range" id="damp-slider" min="0.990" max="1.000" value="0.999" step="0.001">
      </div>
      <div class="btn-row" style="margin-top:12px">
        <button class="btn btn-primary" onclick="resetPendulum()">â†º é‡ç½®</button>
        <button class="btn" onclick="toggleTrail()" id="trail-btn">æ˜¾ç¤ºè½¨è¿¹</button>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>ğŸ“Š å®æ—¶æ•°æ®</h3>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-num" id="period-measured">â€”</div>
          <div class="stat-label">å®æµ‹å‘¨æœŸ (s)</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="period-theory">â€”</div>
          <div class="stat-label">ç†è®ºå‘¨æœŸ (s)</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="pangle-val">â€”</div>
          <div class="stat-label">å½“å‰è§’åº¦ (Â°)</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="pspeed-val">â€”</div>
          <div class="stat-label">è§’é€Ÿåº¦ (Â°/s)</div>
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>ğŸ“š ç‰©ç†åŸç†</h3>
      <div class="info-card">
        <strong>å•æ‘†å‘¨æœŸ</strong>ä¸æ‘†é•¿çš„å¹³æ–¹æ ¹æˆæ­£æ¯”ï¼š
        <div class="formula">T = 2Ï€âˆš(L/g)</div>
        åœ¨å°è§’åº¦ï¼ˆ&lt;15Â°ï¼‰æ‘†åŠ¨æ—¶ï¼Œè¯¥å…¬å¼æœ€ç²¾å‡†ã€‚<br>
        æ³¨æ„ï¼š<span style="color:var(--accent2)">å‘¨æœŸä¸æ‘†çƒè´¨é‡æ— å…³ï¼</span><br>
        <span style="color:var(--muted);font-size:0.72rem">æ”¹å˜æ‘†é•¿ï¼Œè§‚å¯Ÿå®æµ‹ vs ç†è®ºå‘¨æœŸçš„å·®å¼‚</span>
      </div>
    </div>
  </div>

  <!-- ========== COLLISION PAGE ========== -->
  <div class="canvas-area page" id="page-collision-canvas">
    <canvas id="collision-canvas" height="440"></canvas>
    <div class="hint">ğŸ’¡ ç‚¹å‡»"å‘å°„"è®©å°çƒç¢°æ’ï¼Œè§‚å¯ŸåŠ¨é‡å’Œèƒ½é‡çš„å˜åŒ–</div>
  </div>

  <div class="sidebar page" id="page-collision-side">
    <div class="sidebar-section">
      <h3>âš™ ç¢°æ’ç±»å‹</h3>
      <div class="btn-row">
        <button class="mode-btn active" id="mode-elastic" onclick="setCollisionMode('elastic')">å®Œå…¨å¼¹æ€§</button>
        <button class="mode-btn" id="mode-inelastic" onclick="setCollisionMode('inelastic')">å®Œå…¨éå¼¹æ€§</button>
        <button class="mode-btn" id="mode-partial" onclick="setCollisionMode('partial')">éƒ¨åˆ†å¼¹æ€§</button>
      </div>
      <div class="param" style="margin-top:16px">
        <div class="param-label"><span>çƒAè´¨é‡</span><span class="param-value" id="massA-val">2 kg</span></div>
        <input type="range" id="massA-slider" min="1" max="5" value="2" step="0.5">
      </div>
      <div class="param">
        <div class="param-label"><span>çƒBè´¨é‡</span><span class="param-value" id="massB-val">2 kg</span></div>
        <input type="range" id="massB-slider" min="1" max="5" value="2" step="0.5">
      </div>
      <div class="param">
        <div class="param-label"><span>çƒAåˆé€Ÿåº¦</span><span class="param-value" id="velA-val">4 m/s</span></div>
        <input type="range" id="velA-slider" min="1" max="8" value="4" step="0.5">
      </div>
      <div class="btn-row" style="margin-top:12px">
        <button class="btn btn-primary" onclick="fireCollision()">â–¶ å‘å°„</button>
        <button class="btn" onclick="resetCollision()">é‡ç½®</button>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>ğŸ“Š ç¢°æ’å‰åå¯¹æ¯”</h3>
      <div style="font-size:0.75rem;color:var(--muted);margin-bottom:10px">å•ä½ï¼škgÂ·m/s å’Œ J</div>
      <table style="width:100%;border-collapse:collapse;font-size:0.78rem">
        <tr style="color:var(--muted);font-size:0.7rem">
          <td style="padding:4px 0">ç‰©ç†é‡</td>
          <td style="text-align:right;padding:4px 0">ç¢°æ’å‰</td>
          <td style="text-align:right;padding:4px 0">ç¢°æ’å</td>
        </tr>
        <tr style="border-top:1px solid var(--border)">
          <td style="padding:6px 0;color:var(--text)">æ€»åŠ¨é‡ p</td>
          <td style="text-align:right;font-family:'Space Mono';color:var(--accent)" id="p-before">â€”</td>
          <td style="text-align:right;font-family:'Space Mono';color:var(--accent)" id="p-after">â€”</td>
        </tr>
        <tr>
          <td style="padding:6px 0;color:var(--text)">æ€»åŠ¨èƒ½ Ek</td>
          <td style="text-align:right;font-family:'Space Mono';color:var(--accent2)" id="e-before">â€”</td>
          <td style="text-align:right;font-family:'Space Mono';color:var(--accent2)" id="e-after">â€”</td>
        </tr>
      </table>
    </div>

    <div class="sidebar-section">
      <h3>ğŸ“š ç‰©ç†åŸç†</h3>
      <div class="info-card">
        <strong>åŠ¨é‡å®ˆæ’å®šå¾‹</strong>ï¼šæ— è®ºå“ªç§ç¢°æ’ï¼Œç³»ç»Ÿæ€»åŠ¨é‡ä¸å˜ã€‚
        <div class="formula">mâ‚vâ‚ + mâ‚‚vâ‚‚ = mâ‚vâ‚' + mâ‚‚vâ‚‚'</div>
        <strong>èƒ½é‡</strong>ï¼šå¼¹æ€§ç¢°æ’åŠ¨èƒ½å®ˆæ’ï¼›éå¼¹æ€§ç¢°æ’æœ‰èƒ½é‡ä»¥çƒ­ã€å£°ç­‰å½¢å¼æ•£å¤±ã€‚
        <div class="formula">e = (vâ‚‚'âˆ’vâ‚')/(vâ‚âˆ’vâ‚‚)</div>
        <span style="color:var(--muted);font-size:0.72rem">e=1å¼¹æ€§ï¼Œe=0å®Œå…¨éå¼¹æ€§</span>
      </div>
    </div>
  </div>

</div>

<script>
// ==========================================
// TAB SYSTEM
// ==========================================
let currentTab = 'projectile';
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', ['projectile','pendulum','collision'][i] === tab);
  });
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+tab+'-canvas').classList.add('active');
  document.getElementById('page-'+tab+'-side').classList.add('active');
  currentTab = tab;
  if(tab === 'projectile') initProjectile();
  if(tab === 'pendulum') initPendulum();
  if(tab === 'collision') initCollision();
}

// ==========================================
// PROJECTILE MOTION
// ==========================================
let pjCanvas, pjCtx, pjAnim;
let pjBalls = [];
let pjTargets = [];
let pjScore = 0;
let pjTrails = [];

function initProjectile() {
  pjCanvas = document.getElementById('projectile-canvas');
  pjCtx = pjCanvas.getContext('2d');
  pjCanvas.width = pjCanvas.offsetWidth;
  pjCanvas.height = 440;
  pjCanvas.onclick = fireProjectile;
  generateTargets();
  updateSliders();
  drawProjectileScene();
}

function updateSliders() {
  const angle = document.getElementById('angle-slider');
  const speed = document.getElementById('speed-slider');
  const gravity = document.getElementById('gravity-slider');
  if(!angle) return;
  angle.oninput = () => {
    document.getElementById('angle-val').textContent = angle.value + 'Â°';
    drawProjectileScene();
  };
  speed.oninput = () => {
    document.getElementById('speed-val').textContent = speed.value + ' m/s';
    drawProjectileScene();
  };
  gravity.oninput = () => {
    document.getElementById('gravity-val').textContent = parseFloat(gravity.value).toFixed(1) + ' m/sÂ²';
    drawProjectileScene();
  };
  document.getElementById('angle-val').textContent = angle.value + 'Â°';
  document.getElementById('speed-val').textContent = speed.value + ' m/s';
  document.getElementById('gravity-val').textContent = parseFloat(gravity.value).toFixed(1) + ' m/sÂ²';
}

function generateTargets() {
  pjTargets = [];
  const W = pjCanvas ? pjCanvas.width : 800;
  const H = 440;
  const ground = H - 40;
  for(let i = 0; i < 4; i++) {
    pjTargets.push({
      x: 150 + Math.random() * (W - 250),
      y: ground - 10 - Math.random() * 80,
      r: 18,
      hit: false
    });
  }
}

function fireProjectile() {
  if(!pjCanvas) return;
  cancelAnimationFrame(pjAnim);
  const angle = parseFloat(document.getElementById('angle-slider').value) * Math.PI / 180;
  const v0 = parseFloat(document.getElementById('speed-slider').value);
  const g = parseFloat(document.getElementById('gravity-slider').value);
  const W = pjCanvas.width;
  const H = pjCanvas.height;
  const ground = H - 40;
  const scale = W / 120; // pixels per meter

  const vx = v0 * Math.cos(angle) * scale / 10;
  const vy = v0 * Math.sin(angle) * scale / 10;
  const gPx = g * scale / 100;

  // Theory
  const T = 2 * v0 * Math.sin(angle) / g;
  const R = v0 * v0 * Math.sin(2*angle) / g;
  const Hmax = v0 * v0 * Math.sin(angle) * Math.sin(angle) / (2*g);
  document.getElementById('range-val').textContent = R.toFixed(1);
  document.getElementById('maxh-val').textContent = Hmax.toFixed(1);
  document.getElementById('flight-val').textContent = T.toFixed(2);

  let ball = { x: 50, y: ground, vx, vy: -vy, trail: [] };
  let done = false;

  function animate() {
    ball.trail.push({x: ball.x, y: ball.y});
    if(ball.trail.length > 120) ball.trail.shift();
    ball.x += ball.vx;
    ball.vy += gPx;
    ball.y += ball.vy;

    // Hit targets
    pjTargets.forEach(t => {
      if(!t.hit) {
        const dx = ball.x - t.x, dy = ball.y - t.y;
        if(Math.sqrt(dx*dx+dy*dy) < t.r + 8) {
          t.hit = true;
          pjScore++;
          document.getElementById('score-val').textContent = pjScore;
          document.getElementById('score-val').classList.add('score-flash');
          setTimeout(()=>document.getElementById('score-val').classList.remove('score-flash'),500);
          showMsg('proj-msg','ğŸ¯ å‘½ä¸­ï¼');
        }
      }
    });

    if(ball.y >= ground) {
      ball.y = ground;
      done = true;
    }

    pjTrails.push([...ball.trail]);
    if(pjTrails.length > 5) pjTrails.shift();

    drawProjectileScene(ball);
    if(!done) pjAnim = requestAnimationFrame(animate);
    else {
      drawProjectileScene(null);
      // Check all hit
      if(pjTargets.every(t=>t.hit)) {
        showMsg('proj-msg','ğŸ‰ å…¨éƒ¨å‘½ä¸­ï¼');
        setTimeout(()=>{ generateTargets(); drawProjectileScene(); }, 1500);
      }
    }
  }
  animate();
}

function drawProjectileScene(ball) {
  if(!pjCanvas) return;
  const ctx = pjCtx, W = pjCanvas.width, H = pjCanvas.height, ground = H - 40;
  ctx.clearRect(0,0,W,H);

  // Ground
  ctx.fillStyle = '#0d2040';
  ctx.fillRect(0, ground, W, H - ground);
  ctx.strokeStyle = '#1a4a8a';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(0,ground); ctx.lineTo(W,ground); ctx.stroke();

  // Ground grid
  ctx.strokeStyle = 'rgba(0,229,255,0.08)';
  ctx.lineWidth = 1;
  for(let x = 0; x < W; x += 50) {
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,ground); ctx.stroke();
  }
  for(let y = 0; y < ground; y += 50) {
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }

  // Draw angle indicator at origin
  const angle = parseFloat(document.getElementById('angle-slider') ? document.getElementById('angle-slider').value : 45) * Math.PI / 180;
  ctx.save();
  ctx.translate(50, ground);
  ctx.strokeStyle = 'rgba(255,107,53,0.6)';
  ctx.lineWidth = 2;
  ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(70*Math.cos(angle), -70*Math.sin(angle)); ctx.stroke();
  ctx.setLineDash([]);
  // Cannon
  ctx.fillStyle = '#1a4a8a';
  ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = '#00e5ff';
  ctx.beginPath(); ctx.arc(0,0,7,0,Math.PI*2); ctx.fill();
  ctx.restore();

  // Previous trails (ghost)
  pjTrails.forEach((trail, ti) => {
    if(ti === pjTrails.length-1) return;
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(0,229,255,0.12)';
    ctx.lineWidth = 1;
    trail.forEach((p,i) => i===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y));
    ctx.stroke();
  });

  // Current ball trail
  if(ball && ball.trail.length > 1) {
    ctx.beginPath();
    ball.trail.forEach((p,i) => {
      if(i===0) ctx.moveTo(p.x,p.y);
      else ctx.lineTo(p.x,p.y);
    });
    ctx.strokeStyle = 'rgba(0,229,255,0.7)';
    ctx.lineWidth = 2;
    ctx.shadowBlur = 8;
    ctx.shadowColor = '#00e5ff';
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Ball
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2);
    ctx.fillStyle = '#ff6b35';
    ctx.shadowBlur = 15;
    ctx.shadowColor = '#ff6b35';
    ctx.fill();
    ctx.shadowBlur = 0;
  }

  // Targets
  pjTargets.forEach(t => {
    if(t.hit) {
      ctx.strokeStyle = 'rgba(168,255,62,0.4)';
      ctx.lineWidth = 1;
      ctx.setLineDash([3,3]);
      ctx.beginPath(); ctx.arc(t.x, t.y, t.r, 0, Math.PI*2); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = 'rgba(168,255,62,0.2)';
      ctx.font = '20px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('âœ“', t.x, t.y+7);
    } else {
      ctx.beginPath(); ctx.arc(t.x,t.y,t.r,0,Math.PI*2);
      const grad = ctx.createRadialGradient(t.x,t.y,2,t.x,t.y,t.r);
      grad.addColorStop(0,'rgba(255,107,53,0.9)');
      grad.addColorStop(1,'rgba(255,107,53,0.2)');
      ctx.fillStyle = grad;
      ctx.shadowBlur = 12; ctx.shadowColor = '#ff6b35';
      ctx.fill(); ctx.shadowBlur = 0;
      ctx.strokeStyle = '#ff6b35';
      ctx.lineWidth = 2;
      ctx.stroke();
      // Target rings
      ctx.beginPath(); ctx.arc(t.x,t.y,t.r*0.6,0,Math.PI*2);
      ctx.strokeStyle = 'rgba(255,200,0,0.7)'; ctx.lineWidth=1;
      ctx.stroke();
    }
  });
}

function resetProjectile() {
  cancelAnimationFrame(pjAnim);
  pjScore = 0;
  pjTrails = [];
  document.getElementById('score-val').textContent = '0';
  document.getElementById('range-val').textContent = 'â€”';
  document.getElementById('maxh-val').textContent = 'â€”';
  document.getElementById('flight-val').textContent = 'â€”';
  generateTargets();
  drawProjectileScene();
}

// ==========================================
// PENDULUM
// ==========================================
let penCanvas, penCtx, penAnim;
let penAngle = Math.PI/4, penVel = 0;
let penLastZero = null, penPeriod = null;
let penShowTrail = false, penTrailPoints = [];
let penTime = 0;

function initPendulum() {
  penCanvas = document.getElementById('pendulum-canvas');
  penCtx = penCanvas.getContext('2d');
  penCanvas.width = penCanvas.offsetWidth;
  penCanvas.height = 440;

  document.getElementById('plen-slider').oninput = function() {
    document.getElementById('plen-val').textContent = parseFloat(this.value).toFixed(2) + ' m';
    penVel = 0; penLastZero = null; penPeriod = null; penTrailPoints = [];
    updatePendulumTheory();
  };
  document.getElementById('pgrav-slider').oninput = function() {
    document.getElementById('pgrav-val').textContent = parseFloat(this.value).toFixed(1) + ' m/sÂ²';
    penVel = 0; penLastZero = null; penPeriod = null;
    updatePendulumTheory();
  };
  document.getElementById('damp-slider').oninput = function() {
    document.getElementById('damp-val').textContent = parseFloat(this.value).toFixed(3);
  };

  updatePendulumTheory();
  cancelAnimationFrame(penAnim);
  animatePendulum();

  // Drag
  penCanvas.onmousedown = function(e) {
    const rect = penCanvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * penCanvas.width/rect.width;
    const my = (e.clientY - rect.top) * penCanvas.height/rect.height;
    const ox = penCanvas.width/2, oy = 60;
    const L = parseFloat(document.getElementById('plen-slider').value) * getLenScale();
    const bx = ox + Math.sin(penAngle)*L, by = oy + Math.cos(penAngle)*L;
    if(Math.hypot(mx-bx,my-by) < 25) {
      penCanvas.onmousemove = function(e2) {
        const mx2 = (e2.clientX - rect.left)*penCanvas.width/rect.width - ox;
        const my2 = (e2.clientY - rect.top)*penCanvas.height/rect.height - oy;
        penAngle = Math.atan2(mx2, my2);
        penVel = 0; penLastZero = null;
      };
      window.onmouseup = () => { penCanvas.onmousemove = null; window.onmouseup = null; };
    }
  };
}

function getLenScale() { return 150; } // pixels per meter

function updatePendulumTheory() {
  const L = parseFloat(document.getElementById('plen-slider').value);
  const g = parseFloat(document.getElementById('pgrav-slider').value);
  const T = 2*Math.PI*Math.sqrt(L/g);
  document.getElementById('period-theory').textContent = T.toFixed(2);
}

function animatePendulum() {
  if(!penCanvas) return;
  const dt = 0.016;
  const L = parseFloat(document.getElementById('plen-slider').value);
  const g = parseFloat(document.getElementById('pgrav-slider').value);
  const damp = parseFloat(document.getElementById('damp-slider').value);
  const Lpx = L * getLenScale();
  const W = penCanvas.width, H = penCanvas.height;
  const ox = W/2, oy = 60;

  const prevAngle = penAngle;
  penVel += -g/L * Math.sin(penAngle) * dt;
  penVel *= damp;
  penAngle += penVel * dt;
  penTime += dt;

  // Period detection
  if(prevAngle * penAngle < 0 && Math.abs(penVel) > 0.02) {
    if(penLastZero !== null) {
      penPeriod = 2*(penTime - penLastZero);
      document.getElementById('period-measured').textContent = penPeriod.toFixed(2);
    }
    penLastZero = penTime;
  }

  const bx = ox + Math.sin(penAngle)*Lpx;
  const by = oy + Math.cos(penAngle)*Lpx;

  // Stats
  document.getElementById('pangle-val').textContent = (penAngle*180/Math.PI).toFixed(1);
  document.getElementById('pspeed-val').textContent = (penVel*180/Math.PI).toFixed(1);

  if(penShowTrail) {
    penTrailPoints.push({x:bx,y:by});
    if(penTrailPoints.length > 300) penTrailPoints.shift();
  }

  // Draw
  const ctx = penCtx;
  ctx.clearRect(0,0,W,H);

  // Background circle hint
  ctx.beginPath(); ctx.arc(ox,oy,Lpx,0,Math.PI*2);
  ctx.strokeStyle='rgba(0,229,255,0.06)'; ctx.lineWidth=1; ctx.stroke();

  // Trail
  if(penShowTrail && penTrailPoints.length > 2) {
    ctx.beginPath();
    penTrailPoints.forEach((p,i) => i===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y));
    ctx.strokeStyle = 'rgba(0,229,255,0.3)'; ctx.lineWidth=1.5; ctx.stroke();
  }

  // Pivot
  ctx.beginPath(); ctx.arc(ox,oy,8,0,Math.PI*2);
  ctx.fillStyle='#1a4a8a'; ctx.fill();
  ctx.strokeStyle='#00e5ff'; ctx.lineWidth=2; ctx.stroke();

  // Rod
  ctx.beginPath(); ctx.moveTo(ox,oy); ctx.lineTo(bx,by);
  ctx.strokeStyle='rgba(100,160,255,0.7)'; ctx.lineWidth=2;
  ctx.shadowBlur=4; ctx.shadowColor='#00e5ff';
  ctx.stroke(); ctx.shadowBlur=0;

  // Energy color (blue=fast, dim=slow)
  const maxV = Math.sqrt(2*g/L*(1-Math.cos(Math.PI/4)));
  const speed = Math.abs(penVel);
  const t = Math.min(speed/maxV,1);
  const r = Math.round(0 + t*255);
  const gb = Math.round(229 - t*150);

  ctx.beginPath(); ctx.arc(bx,by,18,0,Math.PI*2);
  const grd = ctx.createRadialGradient(bx,by,2,bx,by,18);
  grd.addColorStop(0,`rgba(${r},${gb},255,0.9)`);
  grd.addColorStop(1,`rgba(${r},${gb},255,0.2)`);
  ctx.fillStyle = grd;
  ctx.shadowBlur = 20; ctx.shadowColor = `rgb(${r},${gb},255)`;
  ctx.fill(); ctx.shadowBlur = 0;

  // Vertical reference line
  ctx.setLineDash([4,6]);
  ctx.strokeStyle='rgba(255,107,53,0.3)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(ox,oy); ctx.lineTo(ox,oy+Lpx+10); ctx.stroke();
  ctx.setLineDash([]);

  // Angle arc
  ctx.beginPath();
  ctx.arc(ox,oy,50,Math.PI/2,Math.PI/2+penAngle,penAngle<0);
  ctx.strokeStyle='rgba(255,107,53,0.5)'; ctx.lineWidth=1.5;
  ctx.stroke();

  // Label
  ctx.fillStyle='rgba(255,107,53,0.7)';
  ctx.font='12px Space Mono, monospace';
  ctx.fillText((penAngle*180/Math.PI).toFixed(0)+'Â°', ox+58*Math.sin(penAngle/2), oy+30*Math.cos(penAngle/2));

  penAnim = requestAnimationFrame(animatePendulum);
}

function resetPendulum() {
  penAngle = Math.PI/4; penVel = 0;
  penLastZero = null; penPeriod = null; penTrailPoints = [];
  penTime = 0;
  document.getElementById('period-measured').textContent = 'â€”';
}

function toggleTrail() {
  penShowTrail = !penShowTrail;
  document.getElementById('trail-btn').textContent = penShowTrail ? 'éšè—è½¨è¿¹' : 'æ˜¾ç¤ºè½¨è¿¹';
  if(!penShowTrail) penTrailPoints = [];
}

// ==========================================
// COLLISION
// ==========================================
let colCanvas, colCtx, colAnim;
let colMode = 'elastic';
let colState = 'ready'; // ready, running, done
let ballA, ballB;
let colBefore = null, colAfter = null;

function initCollision() {
  colCanvas = document.getElementById('collision-canvas');
  colCtx = colCanvas.getContext('2d');
  colCanvas.width = colCanvas.offsetWidth;
  colCanvas.height = 440;

  ['massA','massB','velA'].forEach(id => {
    document.getElementById(id+'-slider').oninput = function() {
      const labels = {massA:'massA-val',massB:'massB-val',velA:'velA-val'};
      const units = {massA:' kg',massB:' kg',velA:' m/s'};
      document.getElementById(labels[id]).textContent = parseFloat(this.value).toFixed(1)+units[id];
    };
  });
  resetCollision();
}

function setCollisionMode(mode) {
  colMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mode-'+mode).classList.add('active');
  resetCollision();
}

function resetCollision() {
  cancelAnimationFrame(colAnim);
  colState = 'ready';
  colBefore = null; colAfter = null;
  if(!colCanvas) return;
  const W = colCanvas.width, H = colCanvas.height;
  const mA = parseFloat(document.getElementById('massA-slider').value);
  const mB = parseFloat(document.getElementById('massB-slider').value);
  const vA = parseFloat(document.getElementById('velA-slider').value);
  const rA = 12 + mA * 5, rB = 12 + mB * 5;

  ballA = { x: 80, y: H/2, r: rA, m: mA, v: vA * 3, color: '#00e5ff' };
  ballB = { x: W/2 + 30, y: H/2, r: rB, m: mB, v: 0, color: '#ff6b35' };

  document.getElementById('p-before').textContent = 'â€”';
  document.getElementById('p-after').textContent = 'â€”';
  document.getElementById('e-before').textContent = 'â€”';
  document.getElementById('e-after').textContent = 'â€”';
  drawCollisionScene();
}

function fireCollision() {
  if(!colCanvas) return;
  if(colState === 'running') return;
  if(colState === 'done') { resetCollision(); return; }
  colState = 'running';

  const pBefore = ballA.m*ballA.v + ballB.m*ballB.v;
  const eBefore = 0.5*ballA.m*ballA.v*ballA.v + 0.5*ballB.m*ballB.v*ballB.v;
  document.getElementById('p-before').textContent = pBefore.toFixed(2);
  document.getElementById('e-before').textContent = eBefore.toFixed(2);

  let collided = false;

  function step() {
    ballA.x += ballA.v;
    ballB.x += ballB.v;

    if(!collided && ballA.x + ballA.r >= ballB.x - ballB.r) {
      collided = true;
      // Collision resolution
      const mA = ballA.m, mB = ballB.m, vA = ballA.v, vB = ballB.v;
      let e = colMode === 'elastic' ? 1 : colMode === 'inelastic' ? 0 : 0.5;

      // Combined velocity post
      const newVA = ((mA-e*mB)*vA + mB*(1+e)*vB) / (mA+mB);
      const newVB = ((mB-e*mA)*vB + mA*(1+e)*vA) / (mA+mB);
      ballA.v = newVA; ballB.v = newVB;

      const pAfter = mA*newVA + mB*newVB;
      const eAfter = 0.5*mA*newVA*newVA + 0.5*mB*newVB*newVB;
      document.getElementById('p-after').textContent = pAfter.toFixed(2);
      document.getElementById('e-after').textContent = eAfter.toFixed(2);
    }

    drawCollisionScene();

    const W = colCanvas.width;
    if(ballA.x - ballA.r < 0) ballA.v = Math.abs(ballA.v);
    if(ballA.x + ballA.r > W) ballA.v = -Math.abs(ballA.v);
    if(ballB.x - ballB.r < 0) ballB.v = Math.abs(ballB.v);
    if(ballB.x + ballB.r > W) ballB.v = -Math.abs(ballB.v);

    if(collided && Math.abs(ballA.x - ballB.x) > 200) {
      colState = 'done';
    }
    if(colState === 'running') colAnim = requestAnimationFrame(step);
  }
  step();
}

function drawCollisionScene() {
  if(!colCanvas) return;
  const ctx = colCtx, W = colCanvas.width, H = colCanvas.height;
  ctx.clearRect(0,0,W,H);

  // Track
  const y = H/2;
  ctx.fillStyle = '#0d2040';
  ctx.fillRect(0, y-4, W, 8);
  ctx.strokeStyle = '#1a4a8a'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(0,y-4); ctx.lineTo(W,y-4); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,y+4); ctx.lineTo(W,y+4); ctx.stroke();

  // Friction marks
  ctx.strokeStyle='rgba(26,58,107,0.5)'; ctx.lineWidth=1;
  for(let x=0;x<W;x+=20) { ctx.beginPath(); ctx.moveTo(x,y-4); ctx.lineTo(x+8,y+4); ctx.stroke(); }

  // Velocity arrows
  function drawArrow(x,vy,color,yr) {
    if(Math.abs(vy)<0.3) return;
    const dir = vy>0?1:-1, len = Math.min(Math.abs(vy)*5,60);
    ctx.strokeStyle=color; ctx.lineWidth=2;
    ctx.shadowBlur=8; ctx.shadowColor=color;
    ctx.beginPath(); ctx.moveTo(x,yr); ctx.lineTo(x+len*dir,yr); ctx.stroke();
    ctx.shadowBlur=0;
    ctx.fillStyle=color;
    ctx.beginPath(); ctx.moveTo(x+len*dir,yr); ctx.lineTo(x+len*dir-8*dir,-6+yr); ctx.lineTo(x+len*dir-8*dir,6+yr); ctx.fill();
    ctx.font='11px Space Mono,monospace'; ctx.fillText(Math.abs(vy/3).toFixed(1),x+len*dir/2,yr-10);
  }

  if(ballA) drawArrow(ballA.x, ballA.v, '#00e5ff', y-ballA.r-15);
  if(ballB) drawArrow(ballB.x, ballB.v, '#ff6b35', y-ballB.r-15);

  // Balls
  function drawBall(b) {
    if(!b) return;
    const g = ctx.createRadialGradient(b.x-b.r*0.3,b.y-b.r*0.3,2,b.x,b.y,b.r);
    g.addColorStop(0,'rgba(255,255,255,0.6)');
    g.addColorStop(0.4,b.color+'cc');
    g.addColorStop(1,b.color+'33');
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
    ctx.fillStyle=g;
    ctx.shadowBlur=20; ctx.shadowColor=b.color;
    ctx.fill(); ctx.shadowBlur=0;
    ctx.strokeStyle=b.color; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.8)';
    ctx.font=`bold ${b.r*0.65}px Noto Sans SC`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(b.m+'kg',b.x,b.y);
    ctx.textBaseline='alphabetic';
  }
  drawBall(ballA); drawBall(ballB);
}

// ==========================================
// UTILS
// ==========================================
function showMsg(id, txt) {
  const el = document.getElementById(id);
  el.textContent = txt;
  el.classList.remove('show');
  void el.offsetWidth;
  el.classList.add('show');
}

// Init first tab
window.addEventListener('load', () => {
  setTimeout(initProjectile, 100);
});
window.addEventListener('resize', () => {
  if(currentTab === 'projectile') initProjectile();
  if(currentTab === 'pendulum') initPendulum();
  if(currentTab === 'collision') initCollision();
});
</script>
</body>
</html>
