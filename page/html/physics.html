<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç‰©ç†å®éªŒå®¤ Â· Physics Lab</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;700&display=swap');

:root {
  --bg: #050c1a;
  --surface: #091527;
  --surface2: #0d1e35;
  --border: #152d52;
  --border2: #1e3f70;
  --accent: #00d4f5;
  --accent-dim: rgba(0,212,245,0.12);
  --accent-glow: 0 0 24px rgba(0,212,245,0.35);
  --orange: #ff6b35;
  --orange-dim: rgba(255,107,53,0.12);
  --orange-glow: 0 0 24px rgba(255,107,53,0.35);
  --green: #39ff8f;
  --green-dim: rgba(57,255,143,0.1);
  --text: #c5dcff;
  --text-dim: #4e6f9e;
  --text-mid: #7a9fc4;
  --mono: 'Space Mono', monospace;
  --sans: 'Noto Sans SC', sans-serif;
  --radius: 10px;
  --radius-sm: 6px;
  --header-h: 58px;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(0,212,245,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,212,245,0.025) 1px, transparent 1px);
  background-size: 44px 44px;
  pointer-events: none; z-index: 0;
}

/* â”€â”€ HEADER â”€â”€ */
header {
  position: relative; z-index: 20;
  height: var(--header-h);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px;
  background: rgba(5,12,26,0.96);
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(12px);
  flex-shrink: 0;
}
.logo-wrap { display: flex; align-items: center; gap: 12px; }
.logo-icon {
  width: 34px; height: 34px;
  background: linear-gradient(135deg, var(--accent), #0070ff);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  box-shadow: var(--accent-glow);
  flex-shrink: 0;
}
.logo-text { font-family: var(--mono); font-size: 1.05rem; letter-spacing: 2px; color: var(--accent); text-shadow: var(--accent-glow); }
.logo-sub { font-size: 0.62rem; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; display: none; }
@media (min-width: 480px) { .logo-sub { display: block; } }
.header-badge {
  font-family: var(--mono); font-size: 0.65rem;
  color: var(--text-dim); background: var(--surface2);
  border: 1px solid var(--border); border-radius: 20px;
  padding: 4px 12px; letter-spacing: 1px;
}
@media (max-width: 480px) { .header-badge { display: none; } }

/* â”€â”€ TOP TABS (desktop) â”€â”€ */
.top-tabs {
  position: relative; z-index: 19;
  display: flex;
  background: rgba(9,21,39,0.98);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  overflow-x: auto; scrollbar-width: none;
}
.top-tabs::-webkit-scrollbar { display: none; }
.top-tabs .tab-btn {
  flex: 1; min-width: 110px;
  display: flex; align-items: center; justify-content: center; gap: 7px;
  padding: 13px 16px;
  font-family: var(--sans); font-size: 0.82rem;
  color: var(--text-dim);
  background: transparent; border: none; border-bottom: 2px solid transparent;
  cursor: pointer; transition: color .25s, border-color .25s;
  white-space: nowrap; user-select: none;
}
.top-tabs .tab-btn .icon { font-size: 1rem; }
.top-tabs .tab-btn:hover { color: var(--text); }
.top-tabs .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); text-shadow: 0 0 12px rgba(0,212,245,0.5); }

/* â”€â”€ LAYOUT â”€â”€ */
.app { display: flex; flex-direction: column; height: 100vh; }
.main { flex: 1; overflow: hidden; display: flex; flex-direction: row; position: relative; z-index: 1; }

/* Canvas col */
.canvas-col {
  flex: 1; min-width: 0;
  display: flex; flex-direction: column;
  padding: 16px 14px 12px;
  gap: 10px; overflow: hidden;
}
.canvas-wrap {
  position: relative; flex: 1;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
  background: #020912;
  box-shadow: 0 4px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(0,212,245,0.06);
}
canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }

.canvas-hint {
  display: flex; align-items: center; gap: 8px;
  font-size: 0.72rem; color: var(--text-dim);
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 7px 12px; flex-shrink: 0;
}
.hint-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--accent); flex-shrink: 0;
  box-shadow: 0 0 6px var(--accent);
}

/* Msg overlay */
.msg-overlay {
  position: absolute; top: 38%; left: 50%;
  transform: translateX(-50%);
  font-family: var(--mono); font-size: 1.2rem;
  color: var(--green); text-shadow: 0 0 18px rgba(57,255,143,0.9);
  pointer-events: none; opacity: 0; white-space: nowrap;
}
.msg-overlay.pop { animation: msgPop 2.2s cubic-bezier(.22,1,.36,1) forwards; }
@keyframes msgPop {
  0%   { opacity:0; transform:translateX(-50%) translateY(0)   scale(0.7); }
  18%  { opacity:1; transform:translateX(-50%) translateY(-8px) scale(1.06); }
  70%  { opacity:1; transform:translateX(-50%) translateY(-18px) scale(1); }
  100% { opacity:0; transform:translateX(-50%) translateY(-38px) scale(0.9); }
}

/* Angle badge */
.angle-badge {
  position: absolute; bottom: 10px; right: 12px;
  font-family: var(--mono); font-size: 0.68rem;
  color: var(--orange);
  background: rgba(5,12,26,0.82);
  border: 1px solid rgba(255,107,53,0.22);
  border-radius: var(--radius-sm); padding: 4px 9px;
  pointer-events: none; backdrop-filter: blur(6px);
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: 298px; flex-shrink: 0;
  background: rgba(9,21,39,0.85);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow-y: auto;
  scrollbar-width: thin; scrollbar-color: var(--border2) transparent;
}
.sidebar::-webkit-scrollbar { width: 3px; }
.sidebar::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.panel { padding: 15px; border-bottom: 1px solid rgba(21,45,82,0.5); }
.panel:last-child { border-bottom: none; }
.panel-title {
  font-family: var(--mono); font-size: 0.6rem; letter-spacing: 2.5px;
  text-transform: uppercase; color: var(--accent);
  margin-bottom: 13px;
  display: flex; align-items: center; gap: 8px;
}
.panel-title::after { content:''; flex:1; height:1px; background: linear-gradient(90deg, var(--border), transparent); }

/* Sliders */
.param { margin-bottom: 13px; }
.param:last-child { margin-bottom: 0; }
.param-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
.param-name { font-size: 0.77rem; color: var(--text-mid); }
.param-val { font-family: var(--mono); font-size: 0.8rem; color: var(--orange); min-width: 68px; text-align: right; }

input[type=range] { width:100%; height:20px; -webkit-appearance:none; background:transparent; outline:none; cursor:pointer; }
input[type=range]::-webkit-slider-runnable-track { height:3px; background:var(--border2); border-radius:2px; }
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; width:18px; height:18px; margin-top:-7.5px;
  border-radius:50%; background:var(--accent); border:2px solid var(--bg);
  box-shadow:0 0 10px rgba(0,212,245,0.5);
}
input[type=range]::-moz-range-track { height:3px; background:var(--border2); border-radius:2px; }
input[type=range]::-moz-range-thumb {
  width:18px; height:18px; border-radius:50%; background:var(--accent);
  border:2px solid var(--bg); box-shadow:0 0 10px rgba(0,212,245,0.5);
}

/* Buttons */
.btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:13px; }
.btn {
  flex:1; min-width:68px;
  padding:9px 12px;
  border:1px solid var(--border2); background:var(--surface2);
  color:var(--text-mid); font-family:var(--mono); font-size:0.7rem;
  letter-spacing:0.5px; cursor:pointer; border-radius:var(--radius-sm);
  transition:all .2s; white-space:nowrap;
}
.btn:hover,.btn:active { border-color:var(--accent); color:var(--accent); }
.btn:active { transform:scale(0.96); }
.btn-fire {
  background: linear-gradient(135deg, var(--accent), #0090e0);
  border-color:var(--accent); color:var(--bg); font-weight:700;
  box-shadow:0 2px 14px rgba(0,212,245,0.28);
}
.btn-fire:hover,.btn-fire:active { background:transparent; color:var(--accent); box-shadow:var(--accent-glow); }

/* Stats */
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:7px; }
.stat-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius-sm); padding:9px 11px; text-align:center;
  transition:border-color .3s;
}
.stat-card:hover { border-color:var(--border2); }
.stat-num { font-family:var(--mono); font-size:1.2rem; color:var(--accent); line-height:1.2; }
.stat-label { font-size:0.58rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.7px; margin-top:3px; }
@keyframes numFlash { 0%,100%{color:var(--accent)} 50%{color:var(--green);text-shadow:0 0 18px var(--green)} }
.flash { animation:numFlash .5s ease; }

/* Info card */
.info-card {
  background:rgba(0,212,245,0.04); border:1px solid rgba(0,212,245,0.12);
  border-radius:var(--radius-sm); padding:12px;
  font-size:0.75rem; line-height:1.75; color:var(--text-mid);
}
.info-card strong { color:var(--text); }
.formula {
  font-family:var(--mono); font-size:0.8rem; color:var(--green);
  background:var(--green-dim); border-left:2px solid var(--green);
  border-radius:0 var(--radius-sm) var(--radius-sm) 0;
  padding:5px 10px; margin:7px 0; letter-spacing:0.3px;
}

/* Mode btns */
.mode-row { display:flex; gap:6px; flex-wrap:wrap; }
.mode-btn {
  flex:1; min-width:76px;
  padding:7px 8px;
  border:1px solid var(--border); background:var(--surface);
  color:var(--text-dim); font-family:var(--mono); font-size:0.64rem;
  cursor:pointer; border-radius:var(--radius-sm); transition:all .2s;
}
.mode-btn.active { border-color:var(--orange); color:var(--orange); background:var(--orange-dim); box-shadow:0 0 10px rgba(255,107,53,0.18); }
.mode-btn:hover { border-color:var(--orange); color:var(--orange); }
.mode-btn:active { transform:scale(0.96); }

/* Collision table */
.col-table { width:100%; border-collapse:collapse; font-size:0.74rem; }
.col-table th { font-family:var(--mono); font-size:0.58rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; padding:0 0 7px; text-align:right; font-weight:400; }
.col-table th:first-child { text-align:left; }
.col-table td { padding:6px 0; border-top:1px solid var(--border); text-align:right; color:var(--text); }
.col-table td:first-child { text-align:left; color:var(--text-mid); font-size:0.7rem; }
.col-table .num { font-family:var(--mono); }
.col-table .p-num { color:var(--accent); }
.col-table .e-num { color:var(--orange); }

/* â”€â”€ PAGE VISIBILITY â”€â”€ */
.page { display:none; }
.page.active { display:contents; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 680px) {
  .top-tabs { display:none; }
  .main { flex-direction:column; overflow:hidden; }

  .canvas-col {
    flex:none; padding:8px 8px 0;
    height:50vw; min-height:190px; max-height:285px;
  }
  .canvas-hint { display:none; }

  .sidebar {
    width:100%; border-left:none;
    border-top:1px solid var(--border);
    flex:1; overflow-y:auto;
    padding-bottom:62px;
    scrollbar-width:none;
  }
  .sidebar::-webkit-scrollbar { display:none; }

  .panel { padding:12px; }
  .stat-num { font-size:1.05rem; }
  .param-name { font-size:0.74rem; }
  input[type=range]::-webkit-slider-thumb { width:22px; height:22px; margin-top:-9.5px; }
  .btn { padding:11px 10px; font-size:0.68rem; }
  .bottom-nav { display:flex !important; }
  header { padding:0 12px; }
  .logo-icon { width:30px; height:30px; font-size:14px; }
  .logo-text { font-size:0.95rem; }
}

@media (min-width:681px) {
  .bottom-nav { display:none !important; }
}

/* Bottom nav */
.bottom-nav {
  display:none;
  position:fixed; bottom:0; left:0; right:0;
  height:58px; z-index:100;
  background:rgba(5,12,26,0.97);
  border-top:1px solid var(--border);
  backdrop-filter:blur(14px);
}
.nav-btn {
  flex:1;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:3px;
  background:transparent; border:none;
  color:var(--text-dim); font-family:var(--sans); font-size:0.58rem; letter-spacing:0.5px;
  cursor:pointer; transition:color .2s; padding:5px 0;
  -webkit-tap-highlight-color:transparent;
}
.nav-btn .nav-icon { font-size:1.25rem; line-height:1; }
.nav-btn.active { color:var(--accent); }
.nav-btn.active .nav-icon { filter:drop-shadow(0 0 5px rgba(0,212,245,0.7)); }

@media (min-width:900px) { .sidebar { width:316px; } }
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="logo-wrap">
      <div class="logo-icon">âš—ï¸</div>
      <div>
        <div class="logo-text">PHYSICS LAB</div>
        <div class="logo-sub">äº’åŠ¨ç‰©ç†å®éªŒå®¤</div>
      </div>
    </div>
    <div class="header-badge">3 å®éªŒæ¨¡å—</div>
  </header>

  <div class="top-tabs">
    <button class="tab-btn active" onclick="switchTab('projectile')"><span class="icon">ğŸ¯</span> æŠ›ä½“è¿åŠ¨</button>
    <button class="tab-btn" onclick="switchTab('pendulum')"><span class="icon">ğŸŒ€</span> å•æ‘†å®éªŒ</button>
    <button class="tab-btn" onclick="switchTab('collision')"><span class="icon">ğŸ’¥</span> ç¢°æ’å®ˆæ’</button>
  </div>

  <div class="main">

    <!-- â•â• PROJECTILE â•â• -->
    <div class="canvas-col page active" id="page-projectile-canvas">
      <div class="canvas-wrap">
        <canvas id="projectile-canvas"></canvas>
        <div class="msg-overlay" id="proj-msg"></div>
      </div>
      <div class="canvas-hint">
        <div class="hint-dot"></div>
        ç‚¹å‡»ç”»å¸ƒæˆ–æŒ‰å‘å°„æŒ‰é’®ï¼›è°ƒæ•´è§’åº¦å’Œé€Ÿåº¦ï¼Œå‡»ä¸­å…¨éƒ¨ç›®æ ‡ï¼
      </div>
    </div>

    <div class="sidebar page active" id="page-projectile-side">
      <div class="panel">
        <div class="panel-title">å‘å°„å‚æ•°</div>
        <div class="param">
          <div class="param-row"><span class="param-name">å‘å°„è§’åº¦ Î¸</span><span class="param-val" id="angle-val">45Â°</span></div>
          <input type="range" id="angle-slider" min="10" max="80" value="45">
        </div>
        <div class="param">
          <div class="param-row"><span class="param-name">åˆé€Ÿåº¦ vâ‚€</span><span class="param-val" id="speed-val">50 m/s</span></div>
          <input type="range" id="speed-slider" min="20" max="100" value="50">
        </div>
        <div class="param">
          <div class="param-row"><span class="param-name">é‡åŠ›åŠ é€Ÿåº¦ g</span><span class="param-val" id="gravity-val">9.8 m/sÂ²</span></div>
          <input type="range" id="gravity-slider" min="1" max="25" value="9.8" step="0.1">
        </div>
        <div class="btn-row">
          <button class="btn btn-fire" onclick="fireProjectile()">ğŸš€ å‘å°„</button>
          <button class="btn" onclick="resetProjectile()">â†º é‡ç½®</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">å®æ—¶æ•°æ®</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-num" id="range-val">â€”</div><div class="stat-label">å°„ç¨‹ (m)</div></div>
          <div class="stat-card"><div class="stat-num" id="maxh-val">â€”</div><div class="stat-label">æœ€é«˜ç‚¹ (m)</div></div>
          <div class="stat-card"><div class="stat-num" id="flight-val">â€”</div><div class="stat-label">é£è¡Œæ—¶é—´ (s)</div></div>
          <div class="stat-card"><div class="stat-num" id="score-val" style="color:var(--green)">0</div><div class="stat-label">å‘½ä¸­å¾—åˆ†</div></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ç‰©ç†åŸç†</div>
        <div class="info-card">
          <strong>æŠ›ä½“è¿åŠ¨</strong>æ˜¯ä¸¤ä¸ªç‹¬ç«‹åˆ†è¿åŠ¨çš„åˆæˆï¼š<br>
          æ°´å¹³æ–¹å‘åŒ€é€Ÿã€ç«–ç›´æ–¹å‘åŒ€åŠ é€Ÿè¿åŠ¨ã€‚
          <div class="formula">x = vâ‚€ cosÎ¸ Â· t</div>
          <div class="formula">y = vâ‚€ sinÎ¸ Â· t âˆ’ Â½gtÂ²</div>
          å½“ Î¸ = 45Â° æ—¶æ°´å¹³å°„ç¨‹æœ€å¤§ï¼<br>
          <span style="color:var(--text-dim);font-size:0.7rem">å‘å°„å¤šæ¬¡ï¼Œå¯¹æ¯”ä¸åŒè§’åº¦çš„è½¨è¿¹ï½</span>
        </div>
      </div>
    </div>

    <!-- â•â• PENDULUM â•â• -->
    <div class="canvas-col page" id="page-pendulum-canvas">
      <div class="canvas-wrap">
        <canvas id="pendulum-canvas"></canvas>
        <div class="angle-badge" id="angle-badge">â€” Â°</div>
      </div>
      <div class="canvas-hint">
        <div class="hint-dot" style="background:var(--orange);box-shadow:0 0 6px var(--orange)"></div>
        æ‹–åŠ¨æ‘†çƒæ”¹å˜åˆå§‹è§’åº¦ï¼Œè§‚å¯Ÿæ‘†é•¿å¯¹å‘¨æœŸçš„å½±å“
      </div>
    </div>

    <div class="sidebar page" id="page-pendulum-side">
      <div class="panel">
        <div class="panel-title">å®éªŒå‚æ•°</div>
        <div class="param">
          <div class="param-row"><span class="param-name">æ‘†é•¿ L</span><span class="param-val" id="plen-val">1.00 m</span></div>
          <input type="range" id="plen-slider" min="0.2" max="3.0" value="1.0" step="0.05">
        </div>
        <div class="param">
          <div class="param-row"><span class="param-name">é‡åŠ›åŠ é€Ÿåº¦ g</span><span class="param-val" id="pgrav-val">9.8 m/sÂ²</span></div>
          <input type="range" id="pgrav-slider" min="1" max="25" value="9.8" step="0.1">
        </div>
        <div class="param">
          <div class="param-row"><span class="param-name">é˜»å°¼ç³»æ•°</span><span class="param-val" id="damp-val">0.999</span></div>
          <input type="range" id="damp-slider" min="0.990" max="1.000" value="0.999" step="0.001">
        </div>
        <div class="btn-row">
          <button class="btn btn-fire" onclick="resetPendulum()">â†º é‡ç½®</button>
          <button class="btn" id="trail-btn" onclick="toggleTrail()">è½¨è¿¹ OFF</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">å‘¨æœŸæ¯”è¾ƒ</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-num" id="period-theory" style="color:var(--orange)">â€”</div><div class="stat-label">ç†è®ºå‘¨æœŸ (s)</div></div>
          <div class="stat-card"><div class="stat-num" id="period-measured">â€”</div><div class="stat-label">å®æµ‹å‘¨æœŸ (s)</div></div>
          <div class="stat-card"><div class="stat-num" id="pangle-val">â€”</div><div class="stat-label">è§’åº¦ (Â°)</div></div>
          <div class="stat-card"><div class="stat-num" id="pspeed-val">â€”</div><div class="stat-label">è§’é€Ÿåº¦ (Â°/s)</div></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ç‰©ç†åŸç†</div>
        <div class="info-card">
          <strong>å•æ‘†</strong>çš„å‘¨æœŸä»…ä¸æ‘†é•¿å’Œé‡åŠ›åŠ é€Ÿåº¦æœ‰å…³ï¼š
          <div class="formula">T = 2Ï€ âˆš(L / g)</div>
          åœ¨å°è§’åº¦ï¼ˆ&lt;15Â°ï¼‰ä¸‹å…¬å¼æœ€ä¸ºç²¾å‡†ã€‚<br>
          <span style="color:var(--orange)">å‘¨æœŸä¸æ‘†çƒè´¨é‡æ— å…³ï¼</span><br>
          <span style="color:var(--text-dim);font-size:0.7rem">æ”¹å˜æ‘†é•¿ï¼Œå¯¹æ¯”å®æµ‹ä¸ç†è®ºå‘¨æœŸå·®å¼‚</span>
        </div>
      </div>
    </div>

    <!-- â•â• COLLISION â•â• -->
    <div class="canvas-col page" id="page-collision-canvas">
      <div class="canvas-wrap">
        <canvas id="collision-canvas"></canvas>
      </div>
      <div class="canvas-hint">
        <div class="hint-dot" style="background:var(--orange);box-shadow:0 0 6px var(--orange)"></div>
        è°ƒæ•´å‚æ•°åç‚¹å‡»å‘å°„ï¼Œè§‚å¯Ÿç¢°æ’å‰ååŠ¨é‡å’Œèƒ½é‡çš„å˜åŒ–
      </div>
    </div>

    <div class="sidebar page" id="page-collision-side">
      <div class="panel">
        <div class="panel-title">ç¢°æ’ç±»å‹</div>
        <div class="mode-row">
          <button class="mode-btn active" id="mode-elastic" onclick="setCollisionMode('elastic')">å®Œå…¨å¼¹æ€§</button>
          <button class="mode-btn" id="mode-inelastic" onclick="setCollisionMode('inelastic')">å®Œå…¨éå¼¹æ€§</button>
          <button class="mode-btn" id="mode-partial" onclick="setCollisionMode('partial')">éƒ¨åˆ†å¼¹æ€§</button>
        </div>
        <div style="margin-top:13px">
          <div class="param">
            <div class="param-row"><span class="param-name">çƒA è´¨é‡</span><span class="param-val" id="massA-val">2.0 kg</span></div>
            <input type="range" id="massA-slider" min="1" max="5" value="2" step="0.5">
          </div>
          <div class="param">
            <div class="param-row"><span class="param-name">çƒB è´¨é‡</span><span class="param-val" id="massB-val">2.0 kg</span></div>
            <input type="range" id="massB-slider" min="1" max="5" value="2" step="0.5">
          </div>
          <div class="param">
            <div class="param-row"><span class="param-name">çƒA åˆé€Ÿåº¦</span><span class="param-val" id="velA-val">4.0 m/s</span></div>
            <input type="range" id="velA-slider" min="1" max="8" value="4" step="0.5">
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-fire" onclick="fireCollision()">â–¶ å‘å°„</button>
          <button class="btn" onclick="resetCollision()">â†º é‡ç½®</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ç¢°æ’å‰åå¯¹æ¯”</div>
        <table class="col-table">
          <thead><tr><th>ç‰©ç†é‡</th><th>ç¢°å‰</th><th>ç¢°å</th></tr></thead>
          <tbody>
            <tr><td>æ€»åŠ¨é‡ p (kgÂ·m/s)</td><td class="num p-num" id="p-before">â€”</td><td class="num p-num" id="p-after">â€”</td></tr>
            <tr><td>æ€»åŠ¨èƒ½ Ek (J)</td><td class="num e-num" id="e-before">â€”</td><td class="num e-num" id="e-after">â€”</td></tr>
          </tbody>
        </table>
      </div>

      <div class="panel">
        <div class="panel-title">ç‰©ç†åŸç†</div>
        <div class="info-card">
          <strong>åŠ¨é‡å®ˆæ’</strong>ï¼šæ— è®ºä½•ç§ç¢°æ’ï¼Œç³»ç»Ÿæ€»åŠ¨é‡ä¸å˜ã€‚
          <div class="formula">mâ‚vâ‚ + mâ‚‚vâ‚‚ = mâ‚vâ‚' + mâ‚‚vâ‚‚'</div>
          å¼¹æ€§ç¢°æ’åŠ¨èƒ½å®ˆæ’ï¼›éå¼¹æ€§ç¢°æ’éƒ¨åˆ†åŠ¨èƒ½æ•£å¤±ä¸ºçƒ­æˆ–å£°èƒ½ã€‚
          <div class="formula">e = (vâ‚‚'âˆ’vâ‚') / (vâ‚âˆ’vâ‚‚)</div>
          <span style="color:var(--text-dim);font-size:0.7rem">e=1 å®Œå…¨å¼¹æ€§ï¼Œe=0 å®Œå…¨éå¼¹æ€§</span>
        </div>
      </div>
    </div>

  </div><!-- .main -->

  <nav class="bottom-nav" id="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('projectile')"><span class="nav-icon">ğŸ¯</span>æŠ›ä½“è¿åŠ¨</button>
    <button class="nav-btn" onclick="switchTab('pendulum')"><span class="nav-icon">ğŸŒ€</span>å•æ‘†å®éªŒ</button>
    <button class="nav-btn" onclick="switchTab('collision')"><span class="nav-icon">ğŸ’¥</span>ç¢°æ’å®ˆæ’</button>
  </nav>

</div><!-- .app -->

<script>
'use strict';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TAB SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentTab = 'projectile';

function switchTab(tab) {
  currentTab = tab;
  const names = ['projectile','pendulum','collision'];
  document.querySelectorAll('.top-tabs .tab-btn').forEach((b,i) => b.classList.toggle('active', names[i]===tab));
  document.querySelectorAll('.nav-btn').forEach((b,i) => b.classList.toggle('active', names[i]===tab));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+tab+'-canvas').classList.add('active');
  document.getElementById('page-'+tab+'-side').classList.add('active');
  cancelAnimationFrame(penAnim);
  requestAnimationFrame(() => {
    if (tab==='projectile') initProjectile();
    if (tab==='pendulum')   initPendulum();
    if (tab==='collision')  initCollision();
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMsg(id, txt) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = txt;
  el.classList.remove('pop');
  void el.offsetWidth;
  el.classList.add('pop');
}
function resizeCanvas(canvas) {
  const w = canvas.parentElement.clientWidth;
  const h = canvas.parentElement.clientHeight;
  if (canvas.width!==w || canvas.height!==h) { canvas.width=w; canvas.height=h; return true; }
  return false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROJECTILE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pjCanvas, pjCtx, pjAnim;
let pjTargets=[], pjScore=0, pjTrails=[];

function initProjectile() {
  pjCanvas = document.getElementById('projectile-canvas');
  pjCtx = pjCanvas.getContext('2d');
  resizeCanvas(pjCanvas);
  cancelAnimationFrame(pjAnim);

  const $a = id => document.getElementById(id);
  $a('angle-slider').oninput  = () => { $a('angle-val').textContent  = $a('angle-slider').value + 'Â°'; drawPJ(); };
  $a('speed-slider').oninput  = () => { $a('speed-val').textContent  = $a('speed-slider').value + ' m/s'; drawPJ(); };
  $a('gravity-slider').oninput= () => { $a('gravity-val').textContent= parseFloat($a('gravity-slider').value).toFixed(1)+' m/sÂ²'; drawPJ(); };

  pjCanvas.onclick    = fireProjectile;
  pjCanvas.ontouchend = (e)=>{ e.preventDefault(); fireProjectile(); };

  generateTargets();
  drawPJ();
}

function generateTargets() {
  if (!pjCanvas) return;
  const W=pjCanvas.width, H=pjCanvas.height, G=H-36;
  pjTargets = Array.from({length:4}, ()=>({
    x: 90 + Math.random()*(W-170),
    y: G - 8 - Math.random()*Math.min(55, G*0.38),
    r: 16, hit: false, pulse: 0
  }));
}

function fireProjectile() {
  if (!pjCanvas) return;
  cancelAnimationFrame(pjAnim);
  const $v = id => parseFloat(document.getElementById(id).value);
  const angle = $v('angle-slider')*Math.PI/180;
  const v0    = $v('speed-slider');
  const g     = $v('gravity-slider');
  const W=pjCanvas.width, H=pjCanvas.height, G=H-36;
  const sc = W/100;

  const vx  = v0*Math.cos(angle)*sc*0.01;
  const vyI = v0*Math.sin(angle)*sc*0.01;
  const gPx = g*sc*0.001;

  const T = 2*v0*Math.sin(angle)/g;
  const R = v0*v0*Math.sin(2*angle)/g;
  const Hm= v0*v0*Math.sin(angle)**2/(2*g);
  document.getElementById('range-val').textContent  = R.toFixed(1);
  document.getElementById('maxh-val').textContent   = Hm.toFixed(1);
  document.getElementById('flight-val').textContent = T.toFixed(2);

  let ball={x:42, y:G, vx, vy:-vyI, trail:[]}, done=false;

  function frame() {
    ball.trail.push({x:ball.x,y:ball.y});
    if (ball.trail.length>150) ball.trail.shift();
    ball.x+=ball.vx; ball.vy+=gPx; ball.y+=ball.vy;

    pjTargets.forEach(t=>{
      if (!t.hit && Math.hypot(ball.x-t.x,ball.y-t.y)<t.r+7) {
        t.hit=true; t.pulse=0; pjScore++;
        const sv=document.getElementById('score-val');
        sv.textContent=pjScore; sv.classList.add('flash');
        setTimeout(()=>sv.classList.remove('flash'),500);
        showMsg('proj-msg','ğŸ¯ å‘½ä¸­ï¼+1');
      }
      if (t.hit) t.pulse++;
    });

    if (ball.y>=G) { ball.y=G; done=true; }
    pjTrails.push([...ball.trail]);
    if (pjTrails.length>6) pjTrails.shift();

    drawPJ(ball);
    if (!done) { pjAnim=requestAnimationFrame(frame); }
    else {
      drawPJ(null);
      if (pjTargets.every(t=>t.hit)) {
        showMsg('proj-msg','ğŸ‰ å…¨éƒ¨å‘½ä¸­ï¼');
        setTimeout(()=>{ generateTargets(); drawPJ(); }, 1600);
      }
    }
  }
  frame();
}

function drawPJ(ball) {
  if (!pjCanvas) return;
  const ctx=pjCtx, W=pjCanvas.width, H=pjCanvas.height, G=H-36;
  ctx.clearRect(0,0,W,H);

  // Sky
  const sky=ctx.createLinearGradient(0,0,0,G);
  sky.addColorStop(0,'#020912'); sky.addColorStop(1,'#041326');
  ctx.fillStyle=sky; ctx.fillRect(0,0,W,G);

  // Ground
  const grd=ctx.createLinearGradient(0,G,0,H);
  grd.addColorStop(0,'#0d2040'); grd.addColorStop(1,'#060d1a');
  ctx.fillStyle=grd; ctx.fillRect(0,G,W,H-G);

  // Ground glow line
  ctx.shadowBlur=8; ctx.shadowColor='rgba(0,212,245,0.3)';
  ctx.strokeStyle='#1a4a8a'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(0,G); ctx.lineTo(W,G); ctx.stroke();
  ctx.shadowBlur=0;

  // Grid
  ctx.strokeStyle='rgba(0,212,245,0.04)'; ctx.lineWidth=1;
  for(let x=0;x<W;x+=44){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,G);ctx.stroke();}
  for(let y=0;y<G;y+=44){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

  // Angle guide
  const ang=parseFloat(document.getElementById('angle-slider')?.value||45)*Math.PI/180;
  ctx.save(); ctx.translate(42,G);
  ctx.setLineDash([5,5]); ctx.strokeStyle='rgba(255,107,53,0.45)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(80*Math.cos(ang),-80*Math.sin(ang)); ctx.stroke();
  ctx.setLineDash([]);

  // Cannon
  const cLen=26, cH=7;
  ctx.save(); ctx.rotate(-ang);
  const cg=ctx.createLinearGradient(0,-cH,0,cH);
  cg.addColorStop(0,'#2a5a9a'); cg.addColorStop(1,'#0d2040');
  ctx.fillStyle=cg;
  ctx.beginPath(); ctx.roundRect(0,-cH,cLen,cH*2,3); ctx.fill();
  ctx.strokeStyle='rgba(0,212,245,0.6)'; ctx.lineWidth=1; ctx.stroke();
  ctx.restore();
  // Base
  const bg2=ctx.createRadialGradient(0,0,2,0,0,10);
  bg2.addColorStop(0,'#3a6ab0'); bg2.addColorStop(1,'#0d2040');
  ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2);
  ctx.fillStyle=bg2; ctx.fill();
  ctx.strokeStyle='#00d4f5'; ctx.lineWidth=1.5; ctx.stroke();
  ctx.restore();

  // Ghost trails
  pjTrails.forEach((trail,ti)=>{
    if(ti===pjTrails.length-1) return;
    const a=0.04+ti*0.035;
    ctx.beginPath(); ctx.strokeStyle=`rgba(0,212,245,${a})`; ctx.lineWidth=1.5;
    trail.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
    ctx.stroke();
  });

  // Current trail (gradient)
  if(ball&&ball.trail.length>1){
    for(let i=1;i<ball.trail.length;i++){
      const t=i/ball.trail.length;
      ctx.beginPath();
      ctx.moveTo(ball.trail[i-1].x,ball.trail[i-1].y);
      ctx.lineTo(ball.trail[i].x,ball.trail[i].y);
      ctx.strokeStyle=`rgba(0,212,245,${t*0.85})`;
      ctx.lineWidth=1+t*2;
      ctx.stroke();
    }
    // Ball
    ctx.shadowBlur=20; ctx.shadowColor='#ff6b35';
    const bg3=ctx.createRadialGradient(ball.x-3,ball.y-3,1,ball.x,ball.y,9);
    bg3.addColorStop(0,'#ffb07c'); bg3.addColorStop(1,'#ff3a00');
    ctx.fillStyle=bg3; ctx.beginPath(); ctx.arc(ball.x,ball.y,9,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
  }

  // Targets
  pjTargets.forEach(t=>{
    if(t.hit){
      const fade=Math.min(1,t.pulse/40);
      ctx.globalAlpha=1-fade*0.65;
      ctx.beginPath(); ctx.arc(t.x,t.y,t.r*(1+fade*0.4),0,Math.PI*2);
      ctx.strokeStyle='rgba(57,255,143,0.5)'; ctx.lineWidth=1.5;
      ctx.setLineDash([3,4]); ctx.stroke(); ctx.setLineDash([]);
      ctx.font=`${Math.round(t.r*1.3)}px sans-serif`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillStyle='rgba(57,255,143,0.85)'; ctx.fillText('âœ“',t.x,t.y);
      ctx.globalAlpha=1;
    } else {
      ctx.shadowBlur=15; ctx.shadowColor='#ff6b35';
      const tg=ctx.createRadialGradient(t.x,t.y,2,t.x,t.y,t.r);
      tg.addColorStop(0,'rgba(255,120,50,0.85)'); tg.addColorStop(1,'rgba(255,107,53,0.08)');
      ctx.fillStyle=tg; ctx.beginPath(); ctx.arc(t.x,t.y,t.r,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur=0;
      ctx.strokeStyle='#ff6b35'; ctx.lineWidth=2; ctx.stroke();
      ctx.beginPath(); ctx.arc(t.x,t.y,t.r*0.5,0,Math.PI*2);
      ctx.strokeStyle='rgba(255,200,60,0.7)'; ctx.lineWidth=1; ctx.stroke();
      ctx.beginPath(); ctx.arc(t.x,t.y,3,0,Math.PI*2);
      ctx.fillStyle='#ffe066'; ctx.fill();
    }
    ctx.textBaseline='alphabetic';
  });
}

function resetProjectile() {
  cancelAnimationFrame(pjAnim);
  pjScore=0; pjTrails=[];
  ['score-val','range-val','maxh-val','flight-val'].forEach((id,i)=>{
    document.getElementById(id).textContent = i===0?'0':'â€”';
  });
  generateTargets(); drawPJ();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PENDULUM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let penCanvas, penCtx, penAnim;
let penAngle=Math.PI/4, penVel=0;
let penLastZero=null, penTime=0;
let penShowTrail=false, penTrail=[];
let penDragging=false;

function initPendulum() {
  penCanvas = document.getElementById('pendulum-canvas');
  penCtx = penCanvas.getContext('2d');
  resizeCanvas(penCanvas);

  document.getElementById('plen-slider').oninput = function(){
    document.getElementById('plen-val').textContent = parseFloat(this.value).toFixed(2)+' m';
    penVel=0; penLastZero=null; penTrail=[];
    updatePenTheory();
  };
  document.getElementById('pgrav-slider').oninput = function(){
    document.getElementById('pgrav-val').textContent = parseFloat(this.value).toFixed(1)+' m/sÂ²';
    penVel=0; penLastZero=null;
    updatePenTheory();
  };
  document.getElementById('damp-slider').oninput = function(){
    document.getElementById('damp-val').textContent = parseFloat(this.value).toFixed(3);
  };

  updatePenTheory();
  setupPenDrag();
  cancelAnimationFrame(penAnim);
  animatePen();
}

function getPenScale() {
  if(!penCanvas) return 100;
  return Math.min(penCanvas.height*0.27, penCanvas.width*0.27, 130);
}

function updatePenTheory() {
  const L=parseFloat(document.getElementById('plen-slider').value);
  const g=parseFloat(document.getElementById('pgrav-slider').value);
  document.getElementById('period-theory').textContent=(2*Math.PI*Math.sqrt(L/g)).toFixed(2);
}

function setupPenDrag() {
  const getP = (e)=>{
    const rect=penCanvas.getBoundingClientRect();
    const scX=penCanvas.width/rect.width, scY=penCanvas.height/rect.height;
    const src=e.touches?e.touches[0]:e;
    return {x:(src.clientX-rect.left)*scX, y:(src.clientY-rect.top)*scY};
  };
  const getBall=()=>{
    const L=parseFloat(document.getElementById('plen-slider').value)*getPenScale();
    const ox=penCanvas.width/2, oy=Math.min(60,penCanvas.height*0.14);
    return {bx:ox+Math.sin(penAngle)*L, by:oy+Math.cos(penAngle)*L, ox, oy};
  };
  const onStart=(e)=>{
    const p=getP(e), {bx,by}=getBall();
    if(Math.hypot(p.x-bx,p.y-by)<32){ penDragging=true; e.preventDefault(); }
  };
  const onMove=(e)=>{
    if(!penDragging) return; e.preventDefault();
    const p=getP(e), {ox,oy}=getBall();
    penAngle=Math.max(-Math.PI*0.82,Math.min(Math.PI*0.82, Math.atan2(p.x-ox,p.y-oy)));
    penVel=0; penLastZero=null;
  };
  const onEnd=()=>{ penDragging=false; };
  penCanvas.addEventListener('mousedown', onStart);
  penCanvas.addEventListener('touchstart', onStart, {passive:false});
  window.addEventListener('mousemove', onMove);
  window.addEventListener('touchmove', onMove, {passive:false});
  window.addEventListener('mouseup', onEnd);
  window.addEventListener('touchend', onEnd);
}

function animatePen() {
  if(!penCanvas) return;
  const dt=0.016;
  const L=parseFloat(document.getElementById('plen-slider').value);
  const g=parseFloat(document.getElementById('pgrav-slider').value);
  const damp=parseFloat(document.getElementById('damp-slider').value);
  const Lpx=L*getPenScale();
  const W=penCanvas.width, H=penCanvas.height;
  const ox=W/2, oy=Math.min(60,H*0.14);

  if(!penDragging){
    const prev=penAngle;
    penVel+=-(g/L)*Math.sin(penAngle)*dt;
    penVel*=damp;
    penAngle+=penVel*dt;
    penTime+=dt;
    if(prev*penAngle<0&&Math.abs(penVel)>0.01){
      if(penLastZero!==null)
        document.getElementById('period-measured').textContent=(2*(penTime-penLastZero)).toFixed(2);
      penLastZero=penTime;
    }
  }

  const bx=ox+Math.sin(penAngle)*Lpx;
  const by=oy+Math.cos(penAngle)*Lpx;
  document.getElementById('pangle-val').textContent=(penAngle*180/Math.PI).toFixed(1);
  document.getElementById('pspeed-val').textContent=Math.abs(penVel*180/Math.PI).toFixed(1);
  document.getElementById('angle-badge').textContent=(penAngle*180/Math.PI).toFixed(1)+'Â°';

  if(penShowTrail){ penTrail.push({x:bx,y:by}); if(penTrail.length>500)penTrail.shift(); }

  const ctx=penCtx;
  ctx.clearRect(0,0,W,H);

  // BG
  const bg=ctx.createRadialGradient(ox,H*0.55,0,ox,H*0.55,Math.max(W,H)*0.7);
  bg.addColorStop(0,'#041528'); bg.addColorStop(1,'#020912');
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);

  // Circle hint
  ctx.beginPath(); ctx.arc(ox,oy,Lpx,0,Math.PI*2);
  ctx.strokeStyle='rgba(0,212,245,0.05)'; ctx.lineWidth=1; ctx.stroke();

  // Ceiling bracket
  ctx.fillStyle='#1a3a6a'; ctx.fillRect(ox-26,0,52,12);
  ctx.fillStyle='#243e64'; ctx.fillRect(ox-20,0,40,8);

  // Trail
  if(penShowTrail&&penTrail.length>2){
    for(let i=1;i<penTrail.length;i++){
      const a=(i/penTrail.length)*0.5;
      ctx.beginPath();
      ctx.moveTo(penTrail[i-1].x,penTrail[i-1].y);
      ctx.lineTo(penTrail[i].x,penTrail[i].y);
      ctx.strokeStyle=`rgba(0,212,245,${a})`;
      ctx.lineWidth=1+a*1.5;
      ctx.stroke();
    }
  }

  // Vertical ref
  ctx.setLineDash([4,7]);
  ctx.strokeStyle='rgba(255,107,53,0.22)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(ox,oy); ctx.lineTo(ox,Math.min(oy+Lpx+20,H-10)); ctx.stroke();
  ctx.setLineDash([]);

  // Angle arc
  if(Math.abs(penAngle)>0.02){
    ctx.beginPath(); ctx.arc(ox,oy,46,Math.PI/2,Math.PI/2+penAngle,penAngle<0);
    ctx.strokeStyle='rgba(255,107,53,0.42)'; ctx.lineWidth=1.5; ctx.stroke();
  }

  // Rod
  ctx.shadowBlur=6; ctx.shadowColor='rgba(0,212,245,0.35)';
  ctx.strokeStyle='#3a7bbf'; ctx.lineWidth=2.5;
  ctx.beginPath(); ctx.moveTo(ox,oy); ctx.lineTo(bx,by); ctx.stroke();
  ctx.shadowBlur=0;

  // Pivot
  const pg=ctx.createRadialGradient(ox-2,oy-2,1,ox,oy,7);
  pg.addColorStop(0,'#6ab0ff'); pg.addColorStop(1,'#0d2a50');
  ctx.beginPath(); ctx.arc(ox,oy,7,0,Math.PI*2);
  ctx.fillStyle=pg; ctx.fill();
  ctx.strokeStyle='#00d4f5'; ctx.lineWidth=1.5; ctx.stroke();

  // Bob (color encodes kinetic energy)
  const maxV=Math.sqrt(2*g/L*(1-Math.cos(Math.PI/4)));
  const t=Math.min(Math.abs(penVel)/(maxV||0.001),1);
  const rVal=Math.round(t*230), gVal=Math.round(212-t*170);
  const bobR=15+L*3.5;
  ctx.shadowBlur=22; ctx.shadowColor=`rgb(${rVal},${gVal},245)`;
  const bobG=ctx.createRadialGradient(bx-bobR*.3,by-bobR*.3,2,bx,by,bobR);
  bobG.addColorStop(0,`rgba(${Math.round(rVal*.5+128)},${Math.round(gVal*.5+128)},255,0.95)`);
  bobG.addColorStop(0.6,`rgba(${rVal},${gVal},245,0.8)`);
  bobG.addColorStop(1,`rgba(${rVal},${gVal},245,0.08)`);
  ctx.fillStyle=bobG; ctx.beginPath(); ctx.arc(bx,by,bobR,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  // Specular
  ctx.beginPath(); ctx.arc(bx-bobR*.28,by-bobR*.28,bobR*.22,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,0.28)'; ctx.fill();

  // Drag cue
  if(penDragging){
    ctx.font='11px sans-serif'; ctx.textAlign='center'; ctx.fillStyle='rgba(255,107,53,0.8)';
    ctx.fillText('æ¾å¼€é‡Šæ”¾',bx,by-bobR-8); ctx.textAlign='left';
  }

  penAnim=requestAnimationFrame(animatePen);
}

function resetPendulum() {
  penAngle=Math.PI/4; penVel=0;
  penLastZero=null; penTime=0; penTrail=[];
  document.getElementById('period-measured').textContent='â€”';
}
function toggleTrail() {
  penShowTrail=!penShowTrail;
  const btn=document.getElementById('trail-btn');
  btn.textContent=penShowTrail?'è½¨è¿¹ ON':'è½¨è¿¹ OFF';
  btn.style.borderColor=penShowTrail?'var(--accent)':'';
  btn.style.color=penShowTrail?'var(--accent)':'';
  if(!penShowTrail) penTrail=[];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COLLISION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let colCanvas, colCtx, colAnim;
let colMode='elastic', colState='ready';
let ballA, ballB;

function initCollision() {
  colCanvas=document.getElementById('collision-canvas');
  colCtx=colCanvas.getContext('2d');
  resizeCanvas(colCanvas);
  const units={massA:' kg',massB:' kg',velA:' m/s'};
  ['massA','massB','velA'].forEach(id=>{
    document.getElementById(id+'-slider').oninput=function(){
      document.getElementById(id+'-val').textContent=parseFloat(this.value).toFixed(1)+units[id];
    };
  });
  resetCollision();
}

function setCollisionMode(mode) {
  colMode=mode;
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('mode-'+mode).classList.add('active');
  resetCollision();
}

function resetCollision() {
  cancelAnimationFrame(colAnim); colState='ready';
  if(!colCanvas) return;
  const W=colCanvas.width, H=colCanvas.height;
  const mA=parseFloat(document.getElementById('massA-slider').value);
  const mB=parseFloat(document.getElementById('massB-slider').value);
  const vA=parseFloat(document.getElementById('velA-slider').value);
  const rA=14+mA*6, rB=14+mB*6;
  ballA={x:60, y:H/2, r:rA, m:mA, v:vA*2.5, color:'#00d4f5', label:'A', trail:[]};
  ballB={x:W*0.55, y:H/2, r:rB, m:mB, v:0, color:'#ff6b35', label:'B', trail:[]};
  ['p-before','p-after','e-before','e-after'].forEach(id=>{ document.getElementById(id).textContent='â€”'; });
  drawCol();
}

function fireCollision() {
  if(!colCanvas) return;
  if(colState==='running') return;
  if(colState==='done'){ resetCollision(); return; }
  colState='running';

  const pB=ballA.m*ballA.v+ballB.m*ballB.v;
  const eB=0.5*ballA.m*ballA.v**2+0.5*ballB.m*ballB.v**2;
  document.getElementById('p-before').textContent=pB.toFixed(2);
  document.getElementById('e-before').textContent=eB.toFixed(2);

  let collided=false;
  const W=colCanvas.width;

  function step(){
    ballA.trail.push({x:ballA.x,y:ballA.y}); if(ballA.trail.length>70)ballA.trail.shift();
    ballB.trail.push({x:ballB.x,y:ballB.y}); if(ballB.trail.length>70)ballB.trail.shift();
    ballA.x+=ballA.v; ballB.x+=ballB.v;

    if(!collided&&ballA.x+ballA.r>=ballB.x-ballB.r){
      collided=true;
      const mA=ballA.m,mB=ballB.m,vA=ballA.v,vB=ballB.v;
      const e=colMode==='elastic'?1:colMode==='inelastic'?0:0.5;
      const nA=((mA-e*mB)*vA+mB*(1+e)*vB)/(mA+mB);
      const nB=((mB-e*mA)*vB+mA*(1+e)*vA)/(mA+mB);
      ballA.v=nA; ballB.v=nB;
      const ov=(ballA.x+ballA.r)-(ballB.x-ballB.r);
      ballA.x-=ov/2; ballB.x+=ov/2;
      document.getElementById('p-after').textContent=(mA*nA+mB*nB).toFixed(2);
      document.getElementById('e-after').textContent=(0.5*mA*nA**2+0.5*mB*nB**2).toFixed(2);
    }
    // Walls
    if(ballA.x-ballA.r<0){ballA.v=Math.abs(ballA.v);ballA.x=ballA.r;}
    if(ballA.x+ballA.r>W){ballA.v=-Math.abs(ballA.v);ballA.x=W-ballA.r;}
    if(ballB.x-ballB.r<0){ballB.v=Math.abs(ballB.v);ballB.x=ballB.r;}
    if(ballB.x+ballB.r>W){ballB.v=-Math.abs(ballB.v);ballB.x=W-ballB.r;}

    drawCol();
    if(colState==='running') colAnim=requestAnimationFrame(step);
  }
  step();
}

function drawCol() {
  if(!colCanvas) return;
  const ctx=colCtx, W=colCanvas.width, H=colCanvas.height;
  ctx.clearRect(0,0,W,H);

  // BG
  const bg=ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#020912'); bg.addColorStop(1,'#041020');
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);

  // Track
  const ty=H/2;
  const tg=ctx.createLinearGradient(0,ty-6,0,ty+6);
  tg.addColorStop(0,'#0d2040'); tg.addColorStop(1,'#060d1a');
  ctx.fillStyle=tg; ctx.fillRect(0,ty-6,W,12);
  ctx.shadowBlur=5; ctx.shadowColor='rgba(0,212,245,0.2)';
  ctx.strokeStyle='#1a4a8a'; ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,ty-6);ctx.lineTo(W,ty-6);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,ty+6);ctx.lineTo(W,ty+6);ctx.stroke();
  ctx.shadowBlur=0;
  // Marks
  ctx.strokeStyle='rgba(26,74,138,0.38)'; ctx.lineWidth=1;
  for(let x=0;x<W;x+=18){ctx.beginPath();ctx.moveTo(x,ty-6);ctx.lineTo(x+10,ty+6);ctx.stroke();}

  // Trails
  [ballA,ballB].forEach(b=>{
    if(!b||b.trail.length<2) return;
    for(let i=1;i<b.trail.length;i++){
      const a=(i/b.trail.length)*0.22;
      const c=b.color; // hex
      ctx.beginPath();
      ctx.moveTo(b.trail[i-1].x,b.trail[i-1].y);
      ctx.lineTo(b.trail[i].x,b.trail[i].y);
      // Convert hex to rgba manually
      const r=parseInt(c.slice(1,3),16),g2=parseInt(c.slice(3,5),16),bl=parseInt(c.slice(5,7),16);
      ctx.strokeStyle=`rgba(${r},${g2},${bl},${a})`;
      ctx.lineWidth=2; ctx.stroke();
    }
  });

  // Velocity arrows
  const drawArrow=(b)=>{
    if(!b||Math.abs(b.v)<0.3) return;
    const dir=b.v>0?1:-1, len=Math.min(Math.abs(b.v)*5,70);
    const yr=ty-b.r-22;
    ctx.shadowBlur=8; ctx.shadowColor=b.color;
    ctx.strokeStyle=b.color; ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(b.x,yr);ctx.lineTo(b.x+len*dir,yr);ctx.stroke();
    ctx.shadowBlur=0;
    ctx.fillStyle=b.color;
    ctx.beginPath();ctx.moveTo(b.x+len*dir,yr);
    ctx.lineTo(b.x+len*dir-8*dir,yr-5);ctx.lineTo(b.x+len*dir-8*dir,yr+5);ctx.fill();
    ctx.font='10px Space Mono,monospace'; ctx.textAlign='center'; ctx.fillStyle=b.color;
    ctx.fillText(Math.abs(b.v/2.5).toFixed(1)+' m/s', b.x+(len/2)*dir, yr-8);
    ctx.textAlign='left';
  };
  drawArrow(ballA); drawArrow(ballB);

  // Balls
  const drawBall=(b)=>{
    if(!b) return;
    ctx.shadowBlur=22; ctx.shadowColor=b.color;
    const r=parseInt(b.color.slice(1,3),16), g2=parseInt(b.color.slice(3,5),16), bl=parseInt(b.color.slice(5,7),16);
    const g=ctx.createRadialGradient(b.x-b.r*.3,b.y-b.r*.35,2,b.x,b.y,b.r);
    g.addColorStop(0,'rgba(255,255,255,0.5)');
    g.addColorStop(0.35,`rgba(${r},${g2},${bl},0.75)`);
    g.addColorStop(1,`rgba(${r},${g2},${bl},0.15)`);
    ctx.fillStyle=g; ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
    ctx.strokeStyle=b.color; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.85)';
    ctx.font=`bold ${Math.max(10,b.r*.55)}px Noto Sans SC,sans-serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(b.m+'kg',b.x,b.y+1);
    ctx.font=`bold ${Math.max(9,b.r*.38)}px Space Mono,monospace`;
    ctx.fillStyle='rgba(255,255,255,0.55)'; ctx.fillText(b.label,b.x,b.y-b.r*.45);
    ctx.textAlign='left'; ctx.textBaseline='alphabetic';
  };
  drawBall(ballA); drawBall(ballB);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESIZE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onResize() {
  if(currentTab==='projectile'&&pjCanvas){ resizeCanvas(pjCanvas); generateTargets(); drawPJ(); }
  if(currentTab==='pendulum'  &&penCanvas){ resizeCanvas(penCanvas); }
  if(currentTab==='collision' &&colCanvas){ resizeCanvas(colCanvas); resetCollision(); }
}
window.addEventListener('resize', onResize);

// INIT
window.addEventListener('load', ()=>{ setTimeout(initProjectile, 80); });
</script>
</body>
</html>
