<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHUOWEB - Base64 智能工具</title>

<script src="https://shuoweb.com/icon.js"></script>
<script src="https://shuoweb.com/common.js"></script>
</head>
<body>

<div class="hero section">
  <h1>Base64 智能工具</h1>
  <p>自动识别 · 图片预览 · 拖拽上传 · 一键下载</p>
</div>

<div class="section">
<div class="glass-card" style="max-width:700px;margin:40px auto;padding:30px;">

  <div class="icon-box" style="margin:0 auto 15px;">
    <span id="toolIcon"></span>
  </div>

  <h2>输入内容</h2>
  <input id="inputText"
         placeholder="输入文本或Base64字符串"
         style="overflow-x:auto;">

  <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;">
    <button class="btn-scale" onclick="smartProcess()">智能处理</button>
    <button class="btn-scale" onclick="clearAll()">清空</button>
  </div>

  <h2 style="margin-top:30px;">拖拽或点击上传图片</h2>

  <div id="dropZone"
       style="padding:25px;border:2px dashed #aaa;border-radius:15px;text-align:center;cursor:pointer;">
       拖拽图片到这里 或 点击选择
       <input type="file" id="imageInput" accept="image/*" hidden>
  </div>

  <h2 style="margin-top:30px;">输出结果</h2>

  <input id="outputText"
         readonly
         placeholder="结果将在这里显示..."
         style="overflow-x:auto;">

  <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;">
    <button class="btn-pulse" id="copyBtn" onclick="copyResult()">复制结果</button>
    <button class="btn-scale" id="downloadBtn" onclick="downloadImage()" style="display:none;">
      下载图片
    </button>
  </div>

  <div id="previewBox" style="margin-top:20px;display:none;text-align:center;">
    <h3>图片预览</h3>
    <img id="previewImage"
         style="max-width:100%;max-height:300px;border-radius:12px;">
  </div>

</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  if (typeof ICONS !== "undefined" && ICONS.code) {
    document.getElementById("toolIcon").innerHTML = ICONS.code;
  }
});

const input = document.getElementById("inputText");
const output = document.getElementById("outputText");
const previewBox = document.getElementById("previewBox");
const previewImage = document.getElementById("previewImage");
const downloadBtn = document.getElementById("downloadBtn");
const dropZone = document.getElementById("dropZone");
const imageInput = document.getElementById("imageInput");

/* =====================
   智能识别
===================== */
function smartProcess() {
  const value = input.value.trim();
  previewBox.style.display = "none";
  downloadBtn.style.display = "none";

  if (!value) return;

  if (value.startsWith("data:image")) {
    showImage(value);
    output.value = value;
    return;
  }

  try {
    const decoded = atob(value);
    const text = decodeURIComponent(escape(decoded));
    output.value = text;

    if (text.startsWith("data:image")) {
      showImage(text);
    }
    return;
  } catch {}

  try {
    output.value = btoa(unescape(encodeURIComponent(value)));
  } catch {
    output.value = "处理失败";
  }
}

/* 显示图片 */
function showImage(base64) {
  previewImage.src = base64;
  previewBox.style.display = "block";
  downloadBtn.style.display = "inline-block";
}

/* 拖拽 */
dropZone.addEventListener("click", () => imageInput.click());

dropZone.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.style.borderColor = "#007AFF";
});

dropZone.addEventListener("dragleave", () => {
  dropZone.style.borderColor = "#aaa";
});

dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.style.borderColor = "#aaa";
  handleFile(e.dataTransfer.files[0]);
});

imageInput.addEventListener("change", function() {
  handleFile(this.files[0]);
});

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const base64 = e.target.result;
    output.value = base64;
    showImage(base64);
  };
  reader.readAsDataURL(file);
}

/* 下载 */
function downloadImage() {
  const base64 = output.value;
  if (!base64.startsWith("data:image")) return;

  const link = document.createElement("a");
  const typeMatch = base64.match(/^data:image\/(\w+);/);
  const ext = typeMatch ? typeMatch[1] : "png";

  link.href = base64;
  link.download = "shuoweb_image." + ext;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* 复制 */
async function copyResult() {
  if (!output.value) return;
  const btn = document.getElementById("copyBtn");

  try {
    await navigator.clipboard.writeText(output.value);
    btn.innerText = "已复制 ✓";
    setTimeout(() => btn.innerText = "复制结果", 1500);
  } catch {
    btn.innerText = "复制失败";
  }
}

/* 清空 */
function clearAll() {
  input.value = "";
  output.value = "";
  imageInput.value = "";
  previewBox.style.display = "none";
  downloadBtn.style.display = "none";
}
</script>

</body>
</html>