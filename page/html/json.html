<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON Pro 工具 - ShuoWeb</title>

<script src="https://shuoweb.com/common.js"></script>
<script src="https://shuoweb.com/icon.js"></script>
</head>

<body>

<div class="tool-container">

<h1>
<span data-icon="json"></span>
JSON Pro 格式化工具
</h1>

<input id="jsonInput" placeholder="粘贴 JSON / API 地址 / 拖拽文件">

<div style="margin:12px 0;display:flex;flex-wrap:wrap;gap:10px;">
<button id="formatBtn"><span data-icon="code"></span> 格式化</button>
<button id="fixBtn"><span data-icon="refresh"></span> 自动修复</button>
<button id="validateBtn"><span data-icon="check"></span> 校验</button>
<button id="copyBtn"><span data-icon="copy"></span> 复制</button>
<button id="clearBtn"><span data-icon="trash"></span> 清空</button>
</div>

<div style="display:flex;max-height:420px;overflow:auto;border-radius:12px;">

<!-- 行号 -->
<pre id="lineNumbers" style="margin:0;padding:16px 8px;user-select:none;text-align:right;"></pre>

<!-- 内容 -->
<pre id="jsonOutput" style="margin:0;padding:16px;flex:1;"></pre>

</div>

<div id="messageBox" style="margin-top:10px;"></div>

</div>

<script>
(function(){

const input = document.getElementById("jsonInput");
const output = document.getElementById("jsonOutput");
const linesEl = document.getElementById("lineNumbers");
const msg = document.getElementById("messageBox");

// ===== 本地缓存 =====
input.value = localStorage.getItem("json_cache") || "";
input.addEventListener("input",()=>{
  localStorage.setItem("json_cache",input.value);
});

// ===== 远程 JSON =====
async function tryFetch(text){
  if(text.startsWith("http")){
    const res = await fetch(text);
    return JSON.stringify(await res.json());
  }
  return text;
}

// ===== 自动修复 =====
function autoFix(text){
  text = text.replace(/'/g,'"'); // 单引号
  text = text.replace(/,\s*}/g,'}');
  text = text.replace(/,\s*]/g,']');
  return text;
}

// ===== 折叠渲染 =====
function renderCollapsible(obj, indent=0){
  let html="";
  const space = "&nbsp;".repeat(indent*4);

  if(typeof obj === "object" && obj !== null){
    const isArray = Array.isArray(obj);
    html += `<div>${space}<span class="toggle">▶</span> ${isArray?'[':'{'}</div>`;
    html += `<div style="display:none">`;

    for(let key in obj){
      html += renderCollapsible(obj[key], indent+1);
    }

    html += `${space}${isArray?']':'}'}</div>`;
  }else{
    html += `<div>${space}${escapeHTML(JSON.stringify(obj))}</div>`;
  }

  return html;
}

// ===== 格式化 =====
document.getElementById("formatBtn").onclick = async ()=>{
  clearMsg();
  try{
    let text = await tryFetch(input.value.trim());
    const obj = JSON.parse(text);
    const formatted = JSON.stringify(obj,null,2);
    renderOutput(formatted);
    success("格式化成功");
  }catch(e){
    showError(e);
  }
};

// ===== 自动修复按钮 =====
document.getElementById("fixBtn").onclick = ()=>{
  try{
    const fixed = autoFix(input.value);
    input.value = fixed;
    success("已尝试自动修复");
  }catch(e){
    error("修复失败");
  }
};

// ===== 校验 =====
document.getElementById("validateBtn").onclick = ()=>{
  try{
    JSON.parse(input.value);
    success("JSON 正确");
  }catch(e){
    showError(e);
  }
};

// ===== 复制 =====
document.getElementById("copyBtn").onclick = ()=>{
  const text = output.innerText;
  const ta = document.createElement("textarea");
  ta.value=text;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand("copy");
  document.body.removeChild(ta);
  success("已复制");
};

// ===== 清空 =====
document.getElementById("clearBtn").onclick = ()=>{
  input.value="";
  output.innerHTML="";
  linesEl.textContent="";
  localStorage.removeItem("json_cache");
  clearMsg();
};

// ===== 行号渲染 =====
function renderOutput(text){
  output.innerHTML = highlight(text);
  const lineCount = text.split("\n").length;
  let nums="";
  for(let i=1;i<=lineCount;i++){
    nums += i + "\n";
  }
  linesEl.textContent = nums;
}

// ===== 高亮 =====
function highlight(json){
  json = escapeHTML(json);
  return json.replace(/("(.*?)"(\s*:)?|\b(true|false|null)\b|\b\d+\b)/g,
  function(match){
    let color="#e879f9";
    if(/^"/.test(match)){
      color = /:$/.test(match) ? "#38bdf8" : "#22c55e";
    }else if(/true|false/.test(match)){
      color="#facc15";
    }else if(/null/.test(match)){
      color="#ef4444";
    }
    return `<span style="color:${color}">${match}</span>`;
  });
}

function escapeHTML(str){
  return str.replace(/&/g,"&amp;")
            .replace(/</g,"&lt;")
            .replace(/>/g,"&gt;");
}

// ===== 错误定位 =====
function showError(e){
  let message = e.message;
  let match = message.match(/position (\d+)/);
  if(match){
    const pos = parseInt(match[1]);
    const before = input.value.substring(0,pos);
    const line = before.split("\n").length;
    message += " (第 "+line+" 行)";
  }
  error(message);
}

// ===== 消息 =====
function success(t){
  msg.style.color="green";
  msg.innerHTML='<span data-icon="check"></span> '+t;
}

function error(t){
  msg.style.color="red";
  msg.innerHTML='<span data-icon="warning"></span> '+t;
}

function clearMsg(){
  msg.textContent="";
}

})();
</script>

</body>
</html>