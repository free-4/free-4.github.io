<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>政治倾向测试 | SHUOWEB</title>
  <!-- 加载通用JS -->
  <script src="https://shuoweb.com/common.js"></script>
  <style>
    /* 强制解除全局禁止规则，保证交互正常 */
    * {
      user-select: text !important;
      -webkit-user-select: text !important;
      touch-action: manipulation !important;
    }
    /* 单选框样式，强制优先级 */
    .custom-radio {
      width: 20px !important;
      height: 20px !important;
      min-width: 20px !important;
      border: 2px solid var(--text-sub) !important;
      border-radius: 50% !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      background: var(--card-bg) !important;
      appearance: none !important;
      -webkit-appearance: none !important;
      position: relative !important;
      flex-shrink: 0 !important;
      pointer-events: auto !important;
    }
    .custom-radio.checked {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px var(--primary-light) !important;
    }
    .custom-radio.checked::after {
      content: '' !important;
      position: absolute !important;
      top: 3px !important;
      left: 3px !important;
      width: 10px !important;
      height: 10px !important;
      border-radius: 50% !important;
      background: var(--primary) !important;
    }
    /* 选项样式 */
    .quiz-option {
      cursor: pointer !important;
      transition: color 0.3s ease !important;
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      padding: 8px 10px !important;
      border-radius: 8px !important;
      width: 100% !important;
      text-align: left !important;
      pointer-events: auto !important;
    }
    .quiz-option:hover {
      background: var(--primary-light) !important;
    }
    .quiz-option:hover .opt-text {
      color: var(--primary) !important;
    }
    .opt-text {
      color: var(--text-sub) !important;
      text-align: left !important;
      font-size: 15px !important;
      margin: 0 !important;
      line-height: 1.5 !important;
    }
    .question-title {
      font-size: 16px !important;
      color: var(--text-main) !important;
      margin: 0 0 12px !important;
      text-align: left !important;
      line-height: 1.6 !important;
      font-weight: 600 !important;
    }
    /* 提交按钮：防遮挡+最高优先级可点击 */
    #submit {
      position: relative !important;
      z-index: 9999 !important;
      display: block !important;
      visibility: visible !important;
      width: 100% !important;
      max-width: 400px !important;
      margin: 0 auto !important;
      padding: 14px 0 !important;
      font-size: 16px !important;
      font-weight: 600 !important;
      pointer-events: auto !important;
      cursor: pointer !important;
      background: var(--primary) !important;
      color: #fff !important;
      border: none !important;
      border-radius: 12px !important;
    }
    /* 错误提示 */
    #error-tip {
      color: #FF3B30 !important;
      text-align: center !important;
      padding: 10px !important;
      border-radius: 8px !important;
      background: rgba(255, 59, 48, 0.1) !important;
      margin: 10px 0 !important;
      z-index: 999 !important;
      position: relative !important;
    }
  </style>
</head>
<body>
  <div id="content" style="max-width:800px;padding:20px 15px 80px;margin:0 auto;position:relative;z-index:10;">
    <div class="section" style="background:var(--card-bg);padding:30px 20px;border-radius:var(--radius);box-shadow:var(--shadow);">
      <h1 style="margin:0 0 30px;font-size:28px;">政治倾向测试</h1>
      <!-- 状态提示 -->
      <div id="status-tip" style="text-align:center;padding:20px;color:var(--text-sub);">正在加载题目...</div>
      <div id="error-tip" style="display:none;"></div>
      <!-- 题目容器 -->
      <div id="quiz" style="display:none;flex-direction:column;gap:25px;margin-bottom:30px;"></div>
      <!-- 提交按钮：内联onclick双重保障 -->
      <button 
        id="submit" 
        style="display:none;"
        onclick="window.calculateResult();return false;"
        ontouchend="window.calculateResult();return false;"
      >
        完成测试 · 查看结果
      </button>
      <!-- 结果展示 -->
      <div id="result" style="margin-top:30px;padding-top:30px;border-top:1px solid rgba(255,255,255,0.3);"></div>
    </div>
  </div>

  <script>
    // ====================== 核心：选中状态永久存储，绝对不丢失 ======================
    window.selectStatus = window.selectStatus || {};
    const statusTip = document.getElementById('status-tip');
    const errorTip = document.getElementById('error-tip');
    const quizEl = document.getElementById('quiz');
    const submitBtn = document.getElementById('submit');
    const resultEl = document.getElementById('result');

    // 显示错误
    function showError(msg) {
      errorTip.innerText = msg;
      errorTip.style.display = 'block';
      statusTip.style.display = 'none';
      console.error('错误：', msg);
    }

    // ====================== 核心：同步选中状态到DOM，永远和存储的状态一致 ======================
    function syncSelectStatus() {
      // 遍历所有题目，同步选中状态
      if (!window.PoliticalTest || !window.PoliticalTest.questions) return;
      window.PoliticalTest.questions.forEach(q => {
        const selectedIdx = window.selectStatus[q.id];
        // 找到当前题目所有的单选框
        const allRadios = document.querySelectorAll(`.question-${q.id} .custom-radio`);
        allRadios.forEach((radio, idx) => {
          if (idx === selectedIdx) {
            radio.classList.add('checked');
          } else {
            radio.classList.remove('checked');
          }
        });
      });
    }

    // 渲染题目
    window.renderQuiz = function() {
      if (!window.PoliticalTest || !window.PoliticalTest.questions) {
        showError('题目数据加载失败，请检查data.js是否正确挂载window.PoliticalTest');
        return;
      }

      // 显示内容
      statusTip.style.display = 'none';
      errorTip.style.display = 'none';
      quizEl.style.display = 'flex';
      submitBtn.style.display = 'block';
      quizEl.innerHTML = '';
      
      // 渲染题目
      window.PoliticalTest.questions.forEach((q, idx) => {
        const qDiv = document.createElement('div');
        qDiv.className = `question-${q.id}`;
        qDiv.style.padding = '15px';
        qDiv.style.background = 'rgba(255,255,255,0.05)';
        qDiv.style.borderRadius = '12px';
        
        const qTitle = document.createElement('p');
        qTitle.className = 'question-title';
        qTitle.innerText = `${idx+1}. ${q.text}`;
        qDiv.appendChild(qTitle);
        
        const optDiv = document.createElement('div');
        optDiv.style.display = 'flex';
        optDiv.style.flexDirection = 'column';
        optDiv.style.gap = '6px';

        q.options.forEach((opt, oIdx) => {
          const optionLabel = document.createElement('div');
          optionLabel.className = 'quiz-option';
          optionLabel.setAttribute('data-qid', q.id);
          optionLabel.setAttribute('data-oidx', oIdx);
          
          const radio = document.createElement('div');
          radio.className = 'custom-radio';
          
          const textSpan = document.createElement('p');
          textSpan.className = 'opt-text';
          textSpan.innerText = opt.text;
          
          // ====================== 核心：选项点击逻辑，绝对不被拦截 ======================
          optionLabel.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            const qid = optionLabel.getAttribute('data-qid');
            const oidx = +optionLabel.getAttribute('data-oidx');
            
            // 切换选中状态：已选中则取消，未选中则选中
            if (window.selectStatus[qid] === oidx) {
              delete window.selectStatus[qid];
            } else {
              window.selectStatus[qid] = oidx;
            }
            
            // 同步状态到DOM
            syncSelectStatus();
            return false;
          });

          optionLabel.appendChild(radio);
          optionLabel.appendChild(textSpan);
          optDiv.appendChild(optionLabel);
        });

        qDiv.appendChild(optDiv);
        quizEl.appendChild(qDiv);
      });

      // 渲染完成后，同步一次选中状态，确保之前的选择不丢失
      syncSelectStatus();
    }

    // ====================== 核心：计算结果函数，100%触发 ======================
    window.calculateResult = function() {
      console.log('按钮被点击了！开始计算结果');
      // 防止重复点击
      if (submitBtn.disabled) return;
      submitBtn.disabled = true;
      submitBtn.innerText = '正在计算...';

      try {
        // 数据校验
        if (!window.PoliticalTest) {
          alert('数据异常，请刷新页面重试');
          return;
        }

        // 校验答题情况
        const totalQuestions = window.PoliticalTest.questions.length;
        const answeredCount = Object.keys(window.selectStatus).length;
        console.log('总题数：', totalQuestions, '已答题数：', answeredCount);

        if (answeredCount < totalQuestions) {
          alert(`你还有${totalQuestions - answeredCount}道题未完成，请完成所有题目后再提交`);
          return;
        }

        // 计算分数
        let score = { economic:0, social:0, authority:0, global:0 };
        window.PoliticalTest.questions.forEach(q => {
          const selectedIdx = window.selectStatus[q.id];
          const opt = q.options[selectedIdx];
          score.economic += opt.score?.economic || 0;
          score.social += opt.score?.social || 0;
          score.authority += opt.score?.authority || 0;
          score.global += opt.score?.global || 0;
        });
        console.log('最终得分：', score);

        // 匹配人物
        const matchFigure = window.PoliticalTest.getResult(score);
        console.log('匹配结果：', matchFigure);

        // 渲染结果
        resultEl.innerHTML = `
          <h3 style="font-size:20px;margin:0 0 20px;">你的政治倾向得分</h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:30px;">
            <p style="padding:10px;background:var(--primary-light);border-radius:8px;margin:0;">经济轴：<b style="color:var(--primary);">${score.economic}</b></p>
            <p style="padding:10px;background:var(--primary-light);border-radius:8px;margin:0;">社会轴：<b style="color:var(--primary);">${score.social}</b></p>
            <p style="padding:10px;background:var(--primary-light);border-radius:8px;margin:0;">权威自由轴：<b style="color:var(--primary);">${score.authority}</b></p>
            <p style="padding:10px;background:var(--primary-light);border-radius:8px;margin:0;">国际观轴：<b style="color:var(--primary);">${score.global}</b></p>
          </div>
          <h3 style="font-size:20px;margin:0 0 15px;">你最像：<span style="color:var(--primary);">${matchFigure.name}</span></h3>
          <p style="font-size:16px;padding:15px;background:var(--primary-light);border-radius:8px;margin:0;text-align:center !important;">${matchFigure.desc}</p>
        `;
        // 滚动到结果
        resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (err) {
        console.error('计算出错：', err);
        alert(`出错了：${err.message}`);
      } finally {
        // 恢复按钮
        submitBtn.disabled = false;
        submitBtn.innerText = '完成测试 · 查看结果';
      }
      return false;
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 加载data.js
      const dataScript = document.createElement('script');
      dataScript.src = './data.js';
      dataScript.crossOrigin = 'anonymous';
      
      dataScript.onload = () => {
        console.log('data.js加载成功', window.PoliticalTest);
        window.renderQuiz();
      };

      dataScript.onerror = () => {
        showError('data.js加载失败，请确认文件在当前目录下');
      };

      document.head.appendChild(dataScript);

      // ====================== 核心：全局事件防护，绝对不影响选中状态 ======================
      // 1. 阻止common.js吃掉按钮和选项的点击事件
      document.addEventListener('click', (e) => {
        if (e.target.closest('#submit') || e.target.closest('.quiz-option')) {
          e.stopImmediatePropagation();
        }
      }, true);

      // 2. 点击页面任何地方，都同步一次选中状态，确保不丢失
      document.addEventListener('click', () => {
        syncSelectStatus();
      });

      // 3. 主题切换后，重新渲染题目，保留选中状态
      const themeBtn = document.getElementById('themeText');
      themeBtn && themeBtn.addEventListener('click', () => {
        setTimeout(() => {
          window.renderQuiz();
        }, 150);
      });
    });
  </script>
</body>
</html>
