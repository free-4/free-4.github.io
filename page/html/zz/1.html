<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>政治倾向测试 | SHUOWEB</title>
  <!-- HTTPS协议的通用JS -->
  <script src="https://shuoweb.com/common.js"></script>
  <style>
    /* 单选框：高亮常驻，绝对醒目 */
    .radio-dot {
      width: 20px !important;
      height: 20px !important;
      min-width: 20px !important;
      border: 2px solid var(--text-sub) !important;
      border-radius: 50% !important;
      background: var(--card-bg) !important;
      position: relative !important;
      flex-shrink: 0 !important;
      transition: all 0.2s ease !important;
    }
    /* 选中状态：三层高亮，绝对不会看不见 */
    .radio-dot.checked {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px var(--primary-light) !important;
    }
    .radio-dot.checked::after {
      content: '' !important;
      position: absolute !important;
      top: 3px !important;
      left: 3px !important;
      width: 10px !important;
      height: 10px !important;
      border-radius: 50% !important;
      background: var(--primary) !important;
    }
    /* 选项容器 */
    .option-item {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      padding: 8px 10px !important;
      border-radius: 8px !important;
      cursor: pointer !important;
      width: 100% !important;
    }
    .option-item:hover {
      background: var(--primary-light) !important;
    }
    .option-item:hover .option-text {
      color: var(--primary) !important;
    }
    .option-text {
      color: var(--text-sub) !important;
      text-align: left !important;
      font-size: 15px !important;
      margin: 0 !important;
      line-height: 1.5 !important;
    }
    .question-title {
      font-size: 16px !important;
      color: var(--text-main) !important;
      margin: 0 0 12px !important;
      text-align: left !important;
      line-height: 1.6 !important;
      font-weight: 600 !important;
    }
    /* 提交按钮：最高层级，绝对不被拦截 */
    #submit {
      position: relative !important;
      z-index: 99999 !important;
      display: block !important;
      width: 100% !important;
      max-width: 400px !important;
      margin: 0 auto !important;
      padding: 14px 0 !important;
      font-size: 16px !important;
      font-weight: 600 !important;
      background: var(--primary) !important;
      color: #fff !important;
      border: none !important;
      border-radius: 12px !important;
      cursor: pointer !important;
      pointer-events: auto !important;
    }
    /* 状态提示 */
    #loading {
      text-align: center;
      padding: 20px;
      color: var(--text-sub);
    }
  </style>
</head>
<body>
  <div id="content" style="max-width:800px;padding:20px 15px 80px;margin:0 auto;">
    <div class="section" style="background:var(--card-bg);padding:30px 20px;border-radius:var(--radius);box-shadow:var(--shadow);">
      <h1 style="margin:0 0 30px;font-size:28px;">政治倾向测试</h1>
      <div id="loading">正在加载题目...</div>
      <div id="quiz" style="display:none;flex-direction:column;gap:25px;margin-bottom:30px;"></div>
      <!-- 按钮直接内联onclick，绝对不被拦截 -->
      <button 
        id="submit" 
        style="display:none;"
        onclick="submitTest();return false;"
        ontouchend="submitTest();return false;"
      >
        完成测试 · 查看结果
      </button>
      <div id="result" style="margin-top:30px;padding-top:30px;border-top:1px solid rgba(255,255,255,0.3);"></div>
    </div>
  </div>

  <script>
    // ====================== 核心：全局唯一选中状态，绝对不丢失 ======================
    // 格式：{ 题目ID: 选中的选项索引 }，和data.js里的题目ID完全对应
    window.selectMap = {};
    // 题目数据容器
    window.testData = null;

    // ====================== 核心：渲染题目，状态100%和selectMap绑定 ======================
    function renderQuiz() {
      const quizEl = document.getElementById('quiz');
      const loadingEl = document.getElementById('loading');
      const submitBtn = document.getElementById('submit');
      
      // 数据校验
      if (!window.testData || !window.testData.questions) {
        loadingEl.innerText = '题目加载失败，请检查data.js地址';
        return;
      }

      // 显示内容
      loadingEl.style.display = 'none';
      quizEl.style.display = 'flex';
      submitBtn.style.display = 'block';
      quizEl.innerHTML = '';
      
      // 遍历渲染每一道题，完全和data.js的id对应
      window.testData.questions.forEach(question => {
        // 题目容器
        const qBox = document.createElement('div');
        qBox.className = `question-${question.id}`;
        qBox.style.padding = '15px';
        qBox.style.background = 'rgba(255,255,255,0.05)';
        qBox.style.borderRadius = '12px';
        
        // 题目标题
        const title = document.createElement('p');
        title.className = 'question-title';
        title.innerText = `${question.id}. ${question.text}`;
        qBox.appendChild(title);
        
        // 选项容器
        const optBox = document.createElement('div');
        optBox.style.display = 'flex';
        optBox.style.flexDirection = 'column';
        optBox.style.gap = '6px';

        // 渲染每个选项
        question.options.forEach((option, optIndex) => {
          const optItem = document.createElement('div');
          optItem.className = 'option-item';
          
          // 单选框圆点
          const radioDot = document.createElement('div');
          radioDot.className = 'radio-dot';
          // 直接从全局selectMap拿选中状态，100%准确
          if (window.selectMap[question.id] === optIndex) {
            radioDot.classList.add('checked');
          }
          
          // 选项文字
          const optText = document.createElement('p');
          optText.className = 'option-text';
          optText.innerText = option.text;
          
          // ====================== 核心：选项点击逻辑，稳定常驻 ======================
          optItem.onclick = function(e) {
            // 彻底阻止所有干扰，只执行我们的逻辑
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            const qid = question.id;
            const oid = optIndex;
            
            // 核心逻辑：已选中则取消，未选中则选中
            if (window.selectMap[qid] === oid) {
              // 取消选中
              delete window.selectMap[qid];
              radioDot.classList.remove('checked');
            } else {
              // 选中当前选项，取消同题其他选项
              window.selectMap[qid] = oid;
              // 清除同题所有单选框的选中状态
              const allDots = optBox.querySelectorAll('.radio-dot');
              allDots.forEach(dot => dot.classList.remove('checked'));
              // 给当前选项加选中状态
              radioDot.classList.add('checked');
            }

            // 控制台打印选中状态，方便排查
            console.log('当前选中状态：', window.selectMap);
            return false;
          };

          // 组装选项
          optItem.appendChild(radioDot);
          optItem.appendChild(optText);
          optBox.appendChild(optItem);
        });

        qBox.appendChild(optBox);
        quizEl.appendChild(qBox);
      });
    }

    // ====================== 核心：提交测试，100%正确识别已选题目 ======================
    window.submitTest = function() {
      console.log('按钮点击成功！开始提交');
      const submitBtn = document.getElementById('submit');
      const resultEl = document.getElementById('result');
      
      // 防重复点击
      submitBtn.disabled = true;
      submitBtn.innerText = '正在计算...';

      try {
        // 1. 校验数据
        if (!window.testData) {
          alert('数据异常，请刷新页面重试');
          return;
        }

        // 2. 核心：逐题校验是否完成，绝对不会出现「选了还提示未完成」
        const allQuestions = window.testData.questions;
        let unAnswered = [];
        
        allQuestions.forEach(q => {
          // 检查当前题目id是否在selectMap里，100%准确
          if (window.selectMap[q.id] === undefined) {
            unAnswered.push(q.id);
          }
        });

        // 有未完成的题目，提示
        if (unAnswered.length > 0) {
          alert(`你还有${unAnswered.length}道题未完成（第${unAnswered.join('、')}题），请完成后再提交`);
          submitBtn.disabled = false;
          submitBtn.innerText = '完成测试 · 查看结果';
          return;
        }

        // 3. 计算分数
        let finalScore = { economic:0, social:0, authority:0, global:0 };
        allQuestions.forEach(q => {
          const selectedOpt = q.options[window.selectMap[q.id]];
          finalScore.economic += selectedOpt.score.economic || 0;
          finalScore.social += selectedOpt.score.social || 0;
          finalScore.authority += selectedOpt.score.authority || 0;
          finalScore.global += selectedOpt.score.global || 0;
        });
        console.log('最终得分：', finalScore);

        // 4. 匹配人物
        const matchResult = window.testData.getResult(finalScore);
        console.log('匹配结果：', matchResult);

        // 5. 渲染结果
        resultEl.innerHTML = `
          <h3 style="font-size:20px;margin:0 0 20px;">你的政治倾向得分</h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:30px;">
            <p style="padding:10px;background:var(--primary-light);border-radius:8px;margin:0;">经济轴：<b style="color:var(--primary);">${finalScore.economic}</b></p>
            <p style="padding:10px;background:var(--primary-light);border-radius:8px;margin:0;">社会轴：<b style="color:var(--primary);">${finalScore.social}</b></p>
            <p style="padding:10px;background:var(--primary-light);border-radius:8px;margin:0;">权威自由轴：<b style="color:var(--primary);">${finalScore.authority}</b></p>
            <p style="padding:10px;background:var(--primary-light);border-radius:8px;margin:0;">国际观轴：<b style="color:var(--primary);">${finalScore.global}</b></p>
          </div>
          <h3 style="font-size:20px;margin:0 0 15px;">你最像：<span style="color:var(--primary);">${matchResult.name}</span></h3>
          <p style="font-size:16px;padding:15px;background:var(--primary-light);border-radius:8px;margin:0;text-align:center !important;">${matchResult.desc}</p>
        `;
        // 滚动到结果区域
        resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (err) {
        console.error('提交出错：', err);
        alert(`出错了：${err.message}`);
      } finally {
        // 恢复按钮状态
        submitBtn.disabled = false;
        submitBtn.innerText = '完成测试 · 查看结果';
      }
      return false;
    }

    // ====================== 页面初始化 ======================
    document.addEventListener('DOMContentLoaded', () => {
      // HTTPS协议的题目数据JS
      const dataScript = document.createElement('script');
      dataScript.src = './data.js';
      dataScript.crossOrigin = 'anonymous';
      
      dataScript.onload = () => {
        console.log('data.js加载成功', window.PoliticalTest);
        window.testData = window.PoliticalTest;
        renderQuiz();
      };

      dataScript.onerror = () => {
        document.getElementById('loading').innerText = 'data.js加载失败，请确认地址正确';
      };

      document.head.appendChild(dataScript);

      // 全局事件防护：阻止common.js吃掉我们的点击事件
      document.addEventListener('click', (e) => {
        if (e.target.closest('.option-item') || e.target.closest('#submit')) {
          e.stopImmediatePropagation();
        }
      }, true);

      // 主题切换适配，保留选中状态
      const themeBtn = document.getElementById('themeText');
      themeBtn && themeBtn.addEventListener('click', () => {
        setTimeout(renderQuiz, 150);
      });
    });
  </script>
</body>
</html>
