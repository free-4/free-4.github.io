<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini 3.1 - SHUOWEB 版</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script defer src="https://shuoweb.com/common.js"></script>
    <link rel="stylesheet" href="https://shuoweb.com/css/href.css">
    
    <style>
        /* 1. 强制破解脚本中的“禁止选中”和“禁止粘贴”限制（仅限聊天区） */
        #chat-app-container, #chat-app-container *, .allow-select {
            user-select: text !important;
            -webkit-user-select: text !important;
            -ms-user-select: text !important;
        }

        /* 2. 布局适配 */
        #chat-app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px); /* 减去你自带 Header 的高度 */
            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
        }

        /* 聊天气泡区域 */
        #chat-display {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .msg-row { display: flex; width: 100%; gap: 10px; animation: fadeInUp 0.4s ease; }
        .msg-row.user { flex-direction: row-reverse; }

        .bubble {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            font-size: 15px;
            line-height: 1.6;
            position: relative;
        }
        /* 复用你的主题颜色 */
        .user .bubble { background: var(--primary); color: white; }
        .model .bubble { background: var(--card-bg); color: var(--text-main); backdrop-filter: blur(8px); }

        /* 代码块与 Markdown 优化 */
        pre { 
            background: #1e1e1e; padding: 15px; border-radius: 12px; 
            overflow-x: auto; margin: 10px 0; position: relative;
        }
        code { font-family: 'Consolas', monospace; font-size: 14px; }
        .copy-code-btn {
            position: absolute; top: 8px; right: 8px;
            background: rgba(255,255,255,0.1); color: #fff;
            border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer;
        }

        /* 底部操作区（模型选择 + API Key） */
        .controls {
            padding: 15px;
            background: var(--card-bg);
            border-radius: var(--radius);
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .controls select, .controls input {
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            font-family: inherit;
            background: #fff;
        }

        /* 输入区 */
        .input-box {
            display: flex;
            gap: 10px;
            padding-bottom: 20px;
        }
        #user-input { flex: 1; max-width: none; margin: 0; width: 100%; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="chat-app-container">
    <div id="chat-display"></div>

    <div class="controls">
        <select id="model-select" class="allow-select">
            <option value="gemini-3.1-pro">Gemini 3.1 Pro (深度推理)</option>
            <option value="gemini-3-flash" selected>Gemini 3 Flash (极速响应)</option>
        </select>
        <input type="text" id="api-key" class="allow-select" placeholder="输入API Key..." style="flex:1; min-width:150px;">
        <button class="btn btn-shine" onclick="saveConfig()">锁定配置</button>
        <button class="btn btn-pulse btn-border" onclick="clearChat()">清空对话</button>
    </div>

    <div class="input-box">
        <input type="text" id="user-input" class="combo-duang allow-select" 
               placeholder="在此发送你的问题..." 
               onkeypress="if(event.key==='Enter')sendMsg()">
        <button class="btn btn-scale" onclick="sendMsg()" id="send-btn">发送</button>
    </div>
</div>

<script>
    // 拦截粘贴限制：由于你的 JS 禁止了全局粘贴，我们需要在输入框上强制开启
    const inputEl = document.getElementById('user-input');
    inputEl.addEventListener('paste', (e) => {
        e.stopPropagation(); // 阻止事件冒泡到你那个禁止粘贴的监听器上
    }, true);

    const apiKeyEl = document.getElementById('api-key');
    apiKeyEl.addEventListener('paste', (e) => e.stopPropagation(), true);

    // Markdown 逻辑
    marked.setOptions({
        highlight: function(code, lang) { return hljs.highlightAuto(code).value; },
        breaks: true
    });

    let history = JSON.parse(localStorage.getItem('chat_hist') || '[]');

    window.onload = () => {
        const k = localStorage.getItem('gemini_key');
        if(k) apiKeyEl.value = k;
        render();
    };

    function saveConfig() {
        localStorage.setItem('gemini_key', apiKeyEl.value);
        alert("配置已成功锁定");
    }

    function clearChat() {
        history = [];
        localStorage.removeItem('chat_hist');
        render();
    }

    function render() {
        const display = document.getElementById('chat-display');
        display.innerHTML = '';
        history.forEach((msg, idx) => {
            const isUser = msg.role === 'user';
            const html = isUser ? msg.parts[0].text : marked.parse(msg.parts[0].text);
            
            const div = document.createElement('div');
            div.className = `msg-row ${isUser ? 'user' : 'model'}`;
            div.innerHTML = `
                <div class="bubble allow-select">
                    ${html}
                    ${!isUser ? `<button class="copy-code-btn" style="bottom:-25px; top:auto; color:var(--text-sub)" onclick="copyRaw(${idx})">一键复制全文</button>` : ''}
                </div>
            `;
            display.appendChild(div);
        });
        
        // 为所有代码块添加复制按钮
        document.querySelectorAll('pre').forEach(pre => {
            if (!pre.querySelector('.copy-code-btn')) {
                const b = document.createElement('button');
                b.className = 'copy-code-btn';
                b.innerText = 'Copy Code';
                b.onclick = (e) => {
                    e.stopPropagation();
                    navigator.clipboard.writeText(pre.innerText.replace('Copy Code', ''));
                    b.innerText = 'OK';
                    setTimeout(() => b.innerText = 'Copy Code', 2000);
                };
                pre.appendChild(b);
            }
        });
        display.scrollTop = display.scrollHeight;
    }

    async function sendMsg() {
        const text = inputEl.value.trim();
        const key = apiKeyEl.value;
        const model = document.getElementById('model-select').value;
        
        if(!text || !key) return alert("请检查输入内容和 Key");

        history.push({ role: "user", parts: [{ text }] });
        inputEl.value = '';
        render();

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: history })
            });
            const data = await res.json();
            const reply = data.candidates[0].content.parts[0].text;
            
            history.push({ role: "model", parts: [{ text: reply }] });
            localStorage.setItem('chat_hist', JSON.stringify(history));
            render();
        } catch (e) {
            alert("请求超时或接口错误");
            history.pop();
            render();
        }
    }

    function copyRaw(idx) {
        const text = history[idx].parts[0].text;
        navigator.clipboard.writeText(text).then(() => alert("已复制全文"));
    }
</script>

</body>
</html>
